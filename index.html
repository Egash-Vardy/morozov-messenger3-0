<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Morozov Ultra Maximum v15.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* ГЛОБАЛЬНЫЕ СТИЛИ И ПЕРЕМЕННЫЕ */
        :root {
            --m-blue: #0088cc;
            --m-dark: #0e1621;
            --m-surface: #17212b;
            --m-border: #242f3d;
            --m-chat-bg: #070d14;
            --m-me: #2b5278;
            --m-he: #182533;
            --m-accent: #4fc3f7;
        }

        body, html {
            height: 100%; width: 100%; margin: 0; padding: 0;
            background: var(--m-dark); color: #ffffff;
            font-family: -apple-system, system-ui, "Segoe UI", Roboto, sans-serif;
            overflow: hidden; -webkit-font-smoothing: antialiased;
        }

        /* АНИМАЦИИ И ПЕРЕХОДЫ ЭКРАНОВ */
        .u-screen {
            position: fixed; inset: 0; width: 100%; height: 100%;
            background: var(--m-dark); z-index: 10;
            transition: transform 0.4s cubic-bezier(0.1, 0.7, 0.1, 1), opacity 0.3s;
            display: flex; flex-direction: column;
        }
        .u-screen-hidden { transform: translate3d(100%, 0, 0); opacity: 0; pointer-events: none; }
        .u-screen-active { transform: translate3d(0, 0, 0); opacity: 1; z-index: 50; }

        /* ИНТЕРФЕЙС СООБЩЕНИЙ */
        .u-chat-area {
            flex: 1; overflow-y: auto; padding: 20px 15px;
            background: var(--m-chat-bg);
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: overlay;
            display: flex; flex-direction: column; gap: 10px;
        }

        .u-bubble {
            max-width: 85%; padding: 10px 14px; border-radius: 18px;
            font-size: 15px; position: relative; line-height: 1.4;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .u-bubble-me { align-self: flex-end; background: var(--m-me); border-bottom-right-radius: 4px; }
        .u-bubble-he { align-self: flex-start; background: var(--m-he); border-bottom-left-radius: 4px; }

        .u-time {
            display: flex; align-items: center; justify-content: flex-end;
            gap: 4px; font-size: 10px; opacity: 0.6; margin-top: 5px;
        }
        .u-tick-read { color: var(--m-accent); }

        /* ВХОД В СИСТЕМУ */
        #u-auth-overlay {
            position: fixed; inset: 0; z-index: 9999;
            background: linear-gradient(135deg, #17212b 0%, #0e1621 100%);
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .u-auth-card {
            background: #ffffff; color: #000000; width: 100%; max-width: 380px;
            padding: 40px; border-radius: 40px; box-shadow: 0 30px 60px rgba(0,0,0,0.5);
        }

        /* ЗВОНКИ */
        #u-call-ui {
            position: fixed; inset: 0; z-index: 9000;
            background: #000; display: none; flex-direction: column;
        }
        .u-remote-vid { width: 100%; height: 100%; object-fit: cover; }
        .u-local-vid {
            position: absolute; top: 50px; right: 20px;
            width: 100px; height: 150px; object-fit: cover;
            border-radius: 15px; border: 2px solid #fff; z-index: 9001;
        }

        /* ИНДИКАТОРЫ */
        .u-status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .u-online { background: #4caf50; box-shadow: 0 0 8px #4caf50; }
    </style>
</head>
<body>

    <div id="u-auth-overlay">
        <div class="u-auth-card">
            <h1 class="text-4xl font-black text-blue-600 italic text-center mb-2">ULTRA</h1>
            <p class="text-[10px] text-center font-bold text-gray-400 uppercase tracking-widest mb-8">Infrastructure Maximum v15</p>
            
            <div class="space-y-4">
                <div class="relative">
                    <i class="fas fa-envelope absolute left-4 top-5 text-gray-400"></i>
                    <input id="u-email" type="email" placeholder="Email адрес" class="w-full p-4 pl-12 bg-gray-100 rounded-2xl outline-none focus:ring-2 ring-blue-500 transition">
                </div>
                <div class="relative">
                    <i class="fas fa-lock absolute left-4 top-5 text-gray-400"></i>
                    <input id="u-pass" type="password" placeholder="Пароль" class="w-full p-4 pl-12 bg-gray-100 rounded-2xl outline-none focus:ring-2 ring-blue-500 transition">
                </div>
                <div id="u-reg-fields" class="hidden animate-fade-in">
                    <div class="relative">
                        <i class="fas fa-user absolute left-4 top-5 text-gray-400"></i>
                        <input id="u-nick" type="text" placeholder="Ваше имя" class="w-full p-4 pl-12 bg-gray-100 rounded-2xl outline-none focus:ring-2 ring-blue-500 transition">
                    </div>
                </div>
                
                <button onclick="uCoreAuth()" class="w-full bg-blue-600 text-white p-5 rounded-2xl font-black text-lg shadow-xl active:scale-95 transition-all">ВХОД / РЕГИСТРАЦИЯ</button>
                
                <div class="text-center pt-4">
                    <button onclick="uToggleReg()" id="u-toggle-btn" class="text-xs font-bold text-blue-500 uppercase tracking-widest">Нет аккаунта? Создать</button>
                </div>
                <p id="u-auth-msg" class="text-center text-red-500 text-xs font-bold mt-2"></p>
            </div>
        </div>
    </div>

    <div id="u-scr-list" class="u-screen">
        <header class="h-16 bg-[var(--m-surface)] flex items-center justify-between px-6 border-b border-[var(--m-border)]">
            <button onclick="uLogout()"><i class="fas fa-sign-out-alt text-xl"></i></button>
            <span class="font-black text-xl italic tracking-tighter">MOROZOV <span class="text-blue-500">ULTRA</span></span>
            <button onclick="uSearchFriend()"><i class="fas fa-user-plus text-xl text-blue-400"></i></button>
        </header>

        <div id="u-pending-area" class="bg-blue-600/10 hidden">
            <p class="px-6 py-2 text-[10px] font-black text-blue-400 uppercase">Запросы в друзья</p>
            <div id="u-pending-list"></div>
        </div>

        <div class="px-6 py-4">
            <p class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-4">Ваши контакты</p>
            <div id="u-main-contacts" class="space-y-2"></div>
        </div>
    </div>

    <div id="u-scr-chat" class="u-screen u-screen-hidden">
        <header class="h-16 bg-[var(--m-surface)] flex items-center px-4 border-b border-[var(--m-border)]">
            <button onclick="uBackToList()" class="p-2"><i class="fas fa-chevron-left text-xl"></i></button>
            <div class="flex-1 ml-4">
                <div id="u-target-name" class="font-bold text-lg leading-none">Имя...</div>
                <div class="flex items-center mt-1">
                    <span class="u-status-dot u-online"></span>
                    <span class="text-[9px] font-black text-gray-400 uppercase tracking-tighter">Зашифрованный канал</span>
                </div>
            </div>
            <div class="flex gap-6 pr-2">
                <button onclick="uMakeCall('audio')" class="text-gray-400 hover:text-white"><i class="fas fa-phone-alt"></i></button>
                <button onclick="uMakeCall('video')" class="text-gray-400 hover:text-white"><i class="fas fa-video"></i></button>
            </div>
        </header>

        <div id="u-chat-messages" class="u-chat-area"></div>

        <div class="p-3 bg-[var(--m-surface)] flex items-end gap-3 border-t border-[var(--m-border)]">
            <label class="p-3 cursor-pointer text-gray-400 hover:text-white">
                <i class="fas fa-paperclip text-xl"></i>
                <input type="file" class="hidden" onchange="uHandleFile(this)" accept="image/*">
            </label>
            <div id="u-msg-input" contenteditable="true" class="flex-1 bg-[var(--m-dark)] p-3 rounded-2xl outline-none max-h-32 overflow-y-auto text-sm border border-[var(--m-border)]" oninput="uCheckInput()"></div>
            <button id="u-send-btn" onclick="uPushMsg()" class="hidden w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center shadow-lg active:scale-90 transition">
                <i class="fas fa-paper-plane text-white"></i>
            </button>
            <button id="u-mic-btn" class="w-12 h-12 bg-blue-600/20 text-blue-500 rounded-full flex items-center justify-center" onmousedown="uRecStart()" onmouseup="uRecStop()" ontouchstart="uRecStart()" ontouchend="uRecStop()">
                <i class="fas fa-microphone" id="u-mic-ico"></i>
            </button>
        </div>
    </div>

    <div id="u-call-ui">
        <video id="u-remote-stream" class="u-remote-vid" autoplay playsinline></video>
        <video id="u-local-stream" class="u-local-vid" autoplay muted playsinline></video>
        <div class="absolute inset-0 flex flex-col justify-between items-center py-20 z-[9002]">
            <div class="text-center">
                <div id="u-call-av" class="w-24 h-24 bg-blue-600 rounded-full mx-auto flex items-center justify-center text-4xl font-black mb-4 shadow-2xl border-4 border-white/10">?</div>
                <h2 id="u-call-name" class="text-3xl font-black uppercase">ВЫЗОВ</h2>
                <p class="text-xs text-blue-400 font-bold mt-2 animate-pulse uppercase tracking-widest">P2P ENCRYPTED</p>
            </div>
            <button onclick="uHangup()" class="w-20 h-20 bg-red-600 rounded-full flex items-center justify-center text-3xl shadow-2xl active:scale-75 transition-all">
                <i class="fas fa-phone-slash text-white"></i>
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, update, get, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // КОНФИГУРАЦИЯ БЕЗОПАСНОСТИ (FIREBASE)
        const firebaseConfig = {
            apiKey: "AIzaSyDutfZZER58asyHr68zWlCx7B5k1adFhIk",
            authDomain: "morozov-ultra.firebaseapp.com",
            databaseURL: "https://morozov-ultra-default-rtdb.firebaseio.com",
            projectId: "morozov-ultra",
            storageBucket: "morozov-ultra.firebasestorage.app",
            appId: "1:255345933856:web:5b8d1b93696f36eb5d4645"
        };

        // Инициализация
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let uGlobalUser = null;
        let uActivePartner = null;
        let uRTCPeer = null;
        let uMediaRec = null;
        let uAudioChunks = [];
        let uIsReg = false;

        console.log("Morozov Ultra Maximum: Система инициализирована");

        // --- БЛОК 1: УПРАВЛЕНИЕ АВТОРИЗАЦИЕЙ ---
        window.uToggleReg = () => {
            uIsReg = !uIsReg;
            document.getElementById('u-reg-fields').classList.toggle('hidden', !uIsReg);
            document.getElementById('u-toggle-btn').innerText = uIsReg ? "Есть аккаунт? Войти" : "Нет аккаунта? Создать";
        };

        window.uCoreAuth = async () => {
            const email = document.getElementById('u-email').value.trim();
            const pass = document.getElementById('u-pass').value.trim();
            const nick = document.getElementById('u-nick').value.trim();
            const msg = document.getElementById('u-auth-msg');
            msg.innerText = "Синхронизация...";

            if(!email || pass.length < 6) return msg.innerText = "Ошибка формата данных";

            try {
                if(uIsReg) {
                    const res = await createUserWithEmailAndPassword(auth, email, pass);
                    await updateProfile(res.user, { displayName: nick || "User" });
                    await set(ref(db, `v15/directory/${res.user.uid}`), { email, name: nick || "User", uid: res.user.uid });
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch (err) {
                msg.innerText = "Ошибка: " + err.code;
            }
        };

        onAuthStateChanged(auth, (u) => {
            if(u) {
                uGlobalUser = u;
                document.getElementById('u-auth-overlay').style.display = 'none';
                uStartGlobalSync();
            } else {
                document.getElementById('u-auth-overlay').style.display = 'flex';
            }
        });

        // --- БЛОК 2: СИСТЕМА ДРУЗЕЙ И ПОИСКА ---
        window.uSearchFriend = async () => {
            const email = prompt("Введите точный Email друга:");
            if(!email) return;

            console.log("Поиск пользователя:", email);
            const snap = await get(ref(db, `v15/directory`));
            let target = null;
            snap.forEach(s => { if(s.val().email === email) target = s.val(); });

            if(target && target.uid !== uGlobalUser.uid) {
                await update(ref(db, `v15/social/${target.uid}/${uGlobalUser.uid}`), { id: uGlobalUser.uid, name: uGlobalUser.displayName, status: 'request' });
                await update(ref(db, `v15/social/${uGlobalUser.uid}/${target.uid}`), { id: target.uid, name: target.name, status: 'waiting' });
                alert("Запрос успешно отправлен!");
            } else {
                alert("Пользователь не найден или это вы сами");
            }
        };

        function uStartGlobalSync() {
            // Синхронизация списка друзей
            onValue(ref(db, `v15/social/${uGlobalUser.uid}`), (snap) => {
                const mainBox = document.getElementById('u-main-contacts');
                const pendBox = document.getElementById('u-pending-list');
                const pendArea = document.getElementById('u-pending-area');
                
                mainBox.innerHTML = ""; pendBox.innerHTML = "";
                let hasPending = false;

                snap.forEach(s => {
                    const data = s.val();
                    const el = document.createElement('div');
                    
                    if(data.status === 'request') {
                        hasPending = true;
                        el.className = "flex items-center p-4 bg-white/5 mx-6 my-2 rounded-2xl border border-blue-500/30";
                        el.innerHTML = `<div class="flex-1 font-bold text-sm">${data.name} хочет в друзья</div>
                                        <button onclick="uConfirmFriend('${data.id}')" class="bg-blue-600 px-4 py-2 rounded-xl text-[10px] font-black">ПРИНЯТЬ</button>`;
                        pendBox.appendChild(el);
                    } else if(data.status === 'confirmed') {
                        el.className = "flex items-center p-5 bg-[var(--m-surface)] rounded-3xl border border-[var(--m-border)] active:scale-95 transition cursor-pointer";
                        el.innerHTML = `<div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center font-black mr-4 text-xl">${data.name[0]}</div>
                                        <div class="flex-1"><div class="font-black text-lg">${data.name}</div><div class="text-[10px] opacity-40 uppercase font-bold tracking-widest mt-1">Active Secure Channel</div></div>
                                        <i class="fas fa-chevron-right opacity-20"></i>`;
                        el.onclick = () => uOpenChatRoom(data);
                        mainBox.appendChild(el);
                    }
                });
                pendArea.classList.toggle('hidden', !hasPending);
            });

            uListenForCalls();
        }

        window.uConfirmFriend = async (fid) => {
            await update(ref(db, `v15/social/${uGlobalUser.uid}/${fid}`), { status: 'confirmed' });
            await update(ref(db, `v15/social/${fid}/${uGlobalUser.uid}`), { status: 'confirmed' });
        };

        // --- БЛОК 3: ИНЖЕНЕРИЯ ЧАТА ---
        window.uOpenChatRoom = (partner) => {
            uActivePartner = partner;
            document.getElementById('u-scr-chat').classList.add('u-screen-active');
            document.getElementById('u-target-name').innerText = partner.name;
            
            const roomID = [uGlobalUser.uid, partner.id].sort().join("___");
            
            onValue(ref(db, `v15/messages/${roomID}`), (snap) => {
                const feed = document.getElementById('u-chat-messages');
                feed.innerHTML = "";
                snap.forEach(m => {
                    const d = m.val();
                    const isMe = d.sid === uGlobalUser.uid;

                    // Обновление галочек (прочитано)
                    if(!isMe && d.st !== 2) update(ref(db, `v15/messages/${roomID}/${m.key}`), { st: 2 });

                    const time = new Date(d.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const tick = isMe ? `<i class="fas ${d.st === 2 ? 'fa-check-double u-tick-read' : 'fa-check'} ml-1"></i>` : "";

                    const bubble = document.createElement('div');
                    bubble.className = `u-bubble ${isMe ? 'u-bubble-me' : 'u-bubble-he'}`;
                    
                    let content = `<div>${d.body}</div>`;
                    if(d.tp === 'img') content = `<img src="${d.body}" class="rounded-xl max-w-full shadow-md">`;
                    if(d.tp === 'audio') content = `<audio controls src="${d.body}" class="w-48 scale-90 origin-left"></audio>`;

                    bubble.innerHTML = `${content}<div class="u-time">${time} ${tick}</div>`;
                    feed.appendChild(bubble);
                });
                feed.scrollTop = feed.scrollHeight;
            });
        };

        window.uPushMsg = () => {
            const input = document.getElementById('u-msg-input');
            const text = input.innerText.trim();
            if(text) uExecuteSend('text', text);
            input.innerText = ""; uCheckInput();
        };

        function uExecuteSend(tp, body) {
            const roomID = [uGlobalUser.uid, uActivePartner.id].sort().join("___");
            push(ref(db, `v15/messages/${roomID}`), { sid: uGlobalUser.uid, tp, body, ts: Date.now(), st: 1 });
        }

        window.uHandleFile = (f) => {
            const r = new FileReader();
            r.onload = (e) => uExecuteSend('img', e.target.result);
            r.readAsDataURL(f.files[0]);
        };

        // --- БЛОК 4: ГОЛОСОВОЙ ДВИЖОК ---
        window.uRecStart = async () => {
            uAudioChunks = [];
            try {
                const s = await navigator.mediaDevices.getUserMedia({ audio: true });
                uMediaRec = new MediaRecorder(s);
                uMediaRec.ondataavailable = (e) => uAudioChunks.push(e.data);
                uMediaRec.onstop = () => {
                    const blob = new Blob(uAudioChunks, { type: 'audio/ogg' });
                    const r = new FileReader();
                    r.onload = (e) => uExecuteSend('audio', e.target.result);
                    r.readAsDataURL(blob);
                };
                uMediaRec.start();
                document.getElementById('u-mic-ico').className = "fas fa-circle text-red-500 animate-pulse";
            } catch (e) { alert("Доступ к микрофону заблокирован"); }
        };

        window.uRecStop = () => {
            if(uMediaRec && uMediaRec.state !== 'inactive') {
                uMediaRec.stop();
                document.getElementById('u-mic-ico').className = "fas fa-microphone";
            }
        };

        // --- БЛОК 5: WebRTC ЗВОНКИ (СЛОЖНЫЙ СИГНАЛИНГ) ---
        const rtcConf = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

        window.uMakeCall = async (tp) => {
            console.log("Инициализация вызова:", tp);
            uRTCPeer = new RTCPeerConnection(rtcConf);
            const stream = await navigator.mediaDevices.getUserMedia({ video: tp === 'video', audio: true });
            stream.getTracks().forEach(t => uRTCPeer.addTrack(t, stream));
            
            document.getElementById('u-local-stream').srcObject = stream;
            document.getElementById('u-call-ui').style.display = 'flex';
            document.getElementById('u-call-av').innerText = uActivePartner.name[0];
            document.getElementById('u-call-name').innerText = uActivePartner.name;

            uRTCPeer.onicecandidate = (e) => {
                if(e.candidate) push(ref(db, `v15/calls/${uActivePartner.id}/ice`), e.candidate.toJSON());
            };
            uRTCPeer.ontrack = (e) => document.getElementById('u-remote-stream').srcObject = e.streams[0];

            const off = await uRTCPeer.createOffer();
            await uRTCPeer.setLocalDescription(off);

            set(ref(db, `v15/calls/${uActivePartner.id}/data`), { off, from: uGlobalUser.uid, name: uGlobalUser.displayName, tp });

            onValue(ref(db, `v15/calls/${uActivePartner.id}/ans`), async snap => {
                if(snap.val() && !uRTCPeer.currentRemoteDescription) {
                    await uRTCPeer.setRemoteDescription(new RTCSessionDescription(snap.val()));
                }
            });
        };

        function uListenForCalls() {
            onValue(ref(db, `v15/calls/${uGlobalUser.uid}/data`), async snap => {
                const d = snap.val();
                if(d && d.off && !uRTCPeer) {
                    if(confirm(`Звонок от ${d.name}. Ответить?`)) {
                        uRTCPeer = new RTCPeerConnection(rtcConf);
                        const s = await navigator.mediaDevices.getUserMedia({ video: d.tp === 'video', audio: true });
                        s.getTracks().forEach(t => uRTCPeer.addTrack(t, s));
                        
                        document.getElementById('u-local-stream').srcObject = s;
                        document.getElementById('u-call-ui').style.display = 'flex';
                        uRTCPeer.ontrack = (e) => document.getElementById('u-remote-stream').srcObject = e.streams[0];
                        uRTCPeer.onicecandidate = (e) => {
                            if(e.candidate) push(ref(db, `v15/calls/${d.from}/ice`), e.candidate.toJSON());
                        };

                        await uRTCPeer.setRemoteDescription(new RTCSessionDescription(d.off));
                        const ans = await uRTCPeer.createAnswer();
                        await uRTCPeer.setLocalDescription(ans);
                        set(ref(db, `v15/calls/${d.from}/ans`), ans);

                        onValue(ref(db, `v15/calls/${uGlobalUser.uid}/ice`), sn => {
                            sn.forEach(c => uRTCPeer.addIceCandidate(new RTCIceCandidate(c.val())));
                        });
                    } else {
                        remove(ref(db, `v15/calls/${uGlobalUser.uid}`));
                    }
                }
            });
        }

        // --- БЛОК 6: ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ---
        window.uHangup = () => location.reload();
        window.uBackToList = () => document.getElementById('u-scr-chat').classList.remove('u-screen-active');
        window.uLogout = () => signOut(auth).then(() => location.reload());
        window.uCheckInput = () => {
            const has = document.getElementById('u-msg-input').innerText.trim().length > 0;
            document.getElementById('u-send-btn').classList.toggle('hidden', !has);
            document.getElementById('u-mic-btn').classList.toggle('hidden', has);
        };
    </script>
</body>
</html>
