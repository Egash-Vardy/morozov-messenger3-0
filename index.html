<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>MOROZOV ULTRA | OMNIPOTENCE</title>

    <style>
        /* [ –°–ï–ö–¶–ò–Ø 1: –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –¢–ï–ú–´ ] */
        :root {
            --m-bg: #000000;
            --m-surface: #0c0c0d;
            --m-panel: #151517;
            --m-card: #1c1c1e;
            --m-accent: #007aff;
            --m-accent-dark: #0051ff;
            --m-accent-glow: rgba(0, 122, 255, 0.4);
            --m-text: #ffffff;
            --m-text-alt: #8e8e93;
            --m-text-dim: #48484a;
            --m-border: #2c2c2e;
            --m-danger: #ff453a;
            --m-success: #32d74b;
            --m-grad: linear-gradient(135deg, #007aff, #004599);
            --m-blur: saturate(180%) blur(20px);
            --m-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
            --m-radius-lg: 32px;
            --m-radius-md: 20px;
            --m-anim-main: cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="white"] {
            --m-bg: #f2f2f7;
            --m-surface: #ffffff;
            --m-panel: #fcfcfd;
            --m-card: #ffffff;
            --m-accent: #007aff;
            --m-accent-glow: rgba(0, 122, 255, 0.15);
            --m-text: #1c1c1e;
            --m-text-alt: #636366;
            --m-text-dim: #aeaeb2;
            --m-border: #d1d1d6;
            --m-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);
        }

        /* [ –°–ï–ö–¶–ò–Ø 2: –ë–ê–ó–û–í–´–ô –î–í–ò–ñ–û–ö ] */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--m-bg);
            color: var(--m-text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            transition: background 0.6s var(--m-anim-main);
        }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--m-accent); border-radius: 10px; }

        /* [ –°–ï–ö–¶–ò–Ø 3: –ö–û–ú–ü–û–ù–ï–ù–¢–´ –≠–ö–†–ê–ù–û–í ] */
        .u-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            background: var(--m-bg);
            z-index: 10;
        }

        .u-screen.active {
            display: flex;
            animation: uScreenIn 0.5s var(--m-anim-main);
        }

        @keyframes uScreenIn {
            from { opacity: 0; transform: scale(1.02) translateY(20px); filter: blur(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); filter: blur(0); }
        }

        /* [ –°–ï–ö–¶–ò–Ø 4: –®–ê–ü–ö–ê –ò –ù–ê–í–ò–ì–ê–¶–ò–Ø ] */
        .u-header {
            height: 110px;
            background: var(--m-surface);
            border-bottom: 1px solid var(--m-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            box-shadow: var(--m-shadow);
            z-index: 100;
        }

        .u-logo {
            font-size: 26px;
            font-weight: 900;
            letter-spacing: -1.5px;
            text-transform: uppercase;
        }

        .u-logo span {
            color: var(--m-accent);
            text-shadow: 0 0 20px var(--m-accent-glow);
        }

        .u-nav-bar {
            height: 100px;
            background: var(--m-surface);
            border-top: 1px solid var(--m-border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding-bottom: 30px;
        }

        .u-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            color: var(--m-text-alt);
            cursor: pointer;
            transition: 0.3s;
            flex: 1;
        }

        .u-tab.active { color: var(--m-accent); }
        .u-tab i { font-style: normal; font-size: 24px; }
        .u-tab span { font-size: 10px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; }

        /* [ –°–ï–ö–¶–ò–Ø 5: –ü–û–ò–°–ö –ò –°–ö–ê–ù–ï–† (–í –î–†) ] */
        .u-scanner {
            padding: 25px 30px;
            background: var(--m-panel);
            border-bottom: 1px solid var(--m-border);
        }

        .u-search-box {
            display: flex;
            background: var(--m-bg);
            border: 2px solid var(--m-border);
            border-radius: var(--m-radius-md);
            padding: 6px;
            transition: 0.4s;
        }

        .u-search-box:focus-within {
            border-color: var(--m-accent);
            box-shadow: 0 0 20px var(--m-accent-glow);
        }

        .u-input-field {
            flex: 1;
            background: transparent;
            border: none;
            padding: 15px;
            color: var(--m-text);
            font-size: 16px;
            font-weight: 600;
        }

        .u-btn-prime {
            background: var(--m-accent);
            color: white;
            border: none;
            padding: 0 30px;
            border-radius: 14px;
            font-weight: 900;
            font-size: 13px;
            text-transform: uppercase;
            cursor: pointer;
            transition: 0.3s;
        }

        .u-btn-prime:active { transform: scale(0.94); filter: brightness(0.8); }

        /* [ –°–ï–ö–¶–ò–Ø 6: –°–ü–ò–°–ö–ò –ò –ö–ê–†–¢–û–ß–ö–ò ] */
        .u-scroll-container {
            flex: 1;
            overflow-y: auto;
            padding: 25px 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .u-node-card {
            background: var(--m-card);
            border: 1px solid var(--m-border);
            border-radius: var(--m-radius-lg);
            padding: 22px;
            display: flex;
            align-items: center;
            gap: 18px;
            cursor: pointer;
            transition: 0.4s var(--m-anim-main);
            position: relative;
            overflow: hidden;
        }

        .u-node-card:hover {
            transform: translateX(10px);
            border-color: var(--m-accent);
            background: var(--m-surface);
        }

        .u-ava-ring {
            width: 60px;
            height: 60px;
            background: var(--m-grad);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 900;
            font-size: 24px;
            box-shadow: 0 8px 20px var(--m-accent-glow);
        }

        .u-node-meta h4 { font-size: 19px; font-weight: 900; margin-bottom: 2px; }
        .u-node-meta p { font-size: 11px; color: var(--m-accent); text-transform: uppercase; font-weight: 800; letter-spacing: 0.5px; }

        /* [ –°–ï–ö–¶–ò–Ø 7: –ß–ê–¢ –î–í–ò–ñ–û–ö ] */
        .u-chat-flow {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 18px;
            background: var(--m-bg);
        }

        .u-msg {
            max-width: 80%;
            padding: 18px 24px;
            border-radius: 26px;
            font-size: 16px;
            line-height: 1.5;
            position: relative;
            animation: uMsgSlide 0.4s var(--m-anim-main);
        }

        @keyframes uMsgSlide {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .u-msg.sent {
            align-self: flex-end;
            background: var(--m-accent);
            color: white;
            border-bottom-right-radius: 4px;
            box-shadow: 0 10px 25px var(--m-accent-glow);
        }

        .u-msg.received {
            align-self: flex-start;
            background: var(--m-card);
            border: 1px solid var(--m-border);
            border-bottom-left-radius: 4px;
        }

        /* [ –°–ï–ö–¶–ò–Ø 8: –°–ò–°–¢–ï–ú–ù–´–ï –û–í–ï–†–õ–ï–ò ] */
        #u-preloader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: 1s ease-in-out;
        }

        .u-spinner {
            width: 70px; height: 70px;
            border: 4px solid var(--m-border);
            border-top-color: var(--m-accent);
            border-radius: 50%;
            animation: uSpin 1s linear infinite;
        }

        @keyframes uSpin { to { transform: rotate(360deg); } }

        .u-toast-sys {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--m-accent);
            color: white;
            padding: 18px 45px;
            border-radius: 50px;
            font-weight: 900;
            font-size: 13px;
            z-index: 10001;
            transition: 0.6s cubic-bezier(0.19, 1, 0.22, 1);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .u-toast-sys.active { top: 40px; }

        /* [ –°–ï–ö–¶–ò–Ø 9: CORE SETTINGS ] */
        .u-core-box {
            background: var(--m-card);
            border: 2px solid var(--m-border);
            padding: 30px;
            border-radius: var(--m-radius-lg);
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
        }

        .u-core-box.active { border-color: var(--m-accent); background: var(--m-accent-glow); }
        .u-core-box i { font-size: 40px; display: block; margin-bottom: 10px; }
        .u-core-box span { font-weight: 900; font-size: 12px; text-transform: uppercase; }

    </style>
</head>
<body data-theme="dark">

    <div id="u-preloader">
        <div class="u-spinner"></div>
        <div style="margin-top: 30px; color: var(--m-accent); font-weight: 900; font-size: 11px; letter-spacing: 4px; text-transform: uppercase;">
            Initializing Morozov Engine...
        </div>
    </div>

    <div id="u-toast-sys" class="u-toast-sys">System Ready</div>

    <div id="morozov-app">

        <section id="scr-auth" class="u-screen active">
            <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 50px;">
                <div class="u-logo" style="font-size: 55px; text-align: center; margin-bottom: 5px;">MOROZOV <span>ULTRA</span></div>
                <p style="text-align: center; color: var(--m-text-alt); letter-spacing: 8px; font-size: 11px; margin-bottom: 70px; font-weight: 800;">OMNIPOTENCE V20</p>
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div class="u-search-box">
                        <input type="email" id="auth-email" class="u-input-field" value="egorkamorozoff2014@gmail.com">
                    </div>
                    <div class="u-search-box">
                        <input type="password" id="auth-pass" class="u-input-field" placeholder="ACCESS_CODE">
                    </div>
                    <div class="u-search-box">
                        <input type="text" id="auth-nick" class="u-input-field" placeholder="CALLSIGN (NICKNAME)">
                    </div>
                    <button class="u-btn-prime" style="height: 75px; font-size: 18px; margin-top: 20px; border-radius: 22px;" onclick="Core.handleAuth()">–ò–ù–ò–¶–ò–ò–†–û–í–ê–¢–¨ –í–•–û–î</button>
                    <p id="auth-log" style="text-align: center; font-size: 10px; color: var(--m-danger); margin-top: 15px; font-weight: 900;"></p>
                </div>
            </div>
        </section>

        <section id="scr-hub" class="u-screen">
            <header class="u-header">
                <div class="u-logo">ULTRA <span>HUB</span></div>
                <div id="sys-status" style="padding: 8px 15px; background: var(--m-border); border-radius: 30px; font-size: 9px; font-weight: 900; color: var(--m-success);">STABLE</div>
            </header>

            <div class="u-scanner">
                <div class="u-search-box">
                    <input type="text" id="target-id" class="u-input-field" placeholder="–ü–û–ò–°–ö –£–ó–õ–ê –í –°–ï–¢–ò...">
                    <button class="u-btn-prime" onclick="Core.scanAndLink()">–í –î–†</button>
                </div>
            </div>

            <div id="nodes-list" class="u-scroll-container">
                </div>

            <nav class="u-nav-bar">
                <div class="u-tab active" onclick="Core.navigate('scr-hub')"><i>üì°</i><span>Hub</span></div>
                <div class="u-tab" onclick="Core.navigate('scr-core')"><i>üõ°Ô∏è</i><span>Core</span></div>
            </nav>
        </section>

        <section id="scr-chat" class="u-screen">
            <header class="u-header">
                <button onclick="Core.navigate('scr-hub')" style="background:none; border:none; color:var(--m-text); font-size: 30px; cursor:pointer;">‚Üê</button>
                <div id="peer-title" class="u-logo" style="font-size: 20px;">NODE <span>LINK</span></div>
                <div class="u-ava-ring" style="width: 45px; height: 45px; font-size: 18px;" id="peer-ava">?</div>
            </header>

            <div id="msg-stream" class="u-chat-flow"></div>

            <div class="u-scanner">
                <div class="u-search-box">
                    <input type="text" id="msg-input" class="u-input-field" placeholder="–ü–ï–†–ï–î–ê–ß–ê –°–ò–ì–ù–ê–õ–ê...">
                    <button class="u-btn-prime" onclick="Core.transmit()">üì°</button>
                </div>
            </div>
        </section>

        <section id="scr-core" class="u-screen">
            <header class="u-header"><div class="u-logo">ULTRA <span>CORE</span></div></header>
            
            <div class="u-scroll-container">
                <h3 style="font-size: 12px; color: var(--m-text-alt); text-transform: uppercase; margin-bottom: 20px; font-weight: 900;">–ò–ù–¢–ï–†–§–ï–ô–°–ù–´–ï –ú–ê–¢–†–ò–¶–´</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="u-core-box active" id="th-dark" onclick="Core.updateTheme('dark')"><i>üåë</i><span>Obsidian Dark</span></div>
                    <div class="u-core-box" id="th-white" onclick="Core.updateTheme('white')"><i>‚ö™</i><span>Platinum White</span></div>
                </div>

                <div style="margin-top: 50px;">
                    <h3 style="font-size: 12px; color: var(--m-text-alt); text-transform: uppercase; margin-bottom: 20px; font-weight: 900;">–ò–î–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø –í–õ–ê–î–ï–õ–¨–¶–ê</h3>
                    <div class="u-node-card" style="cursor: default;">
                        <div class="u-ava-ring" id="my-big-ava">?</div>
                        <div class="u-node-meta">
                            <h4 id="my-nick-display">USER_NODE</h4>
                            <p>PRIMARY_MASTER_NODE</p>
                        </div>
                    </div>
                </div>

                <button class="u-btn-prime" style="width: 100%; height: 75px; margin-top: 50px; background: var(--m-danger); border-radius: 22px;" onclick="Core.emergencyExit()">–¢–ï–†–ú–ò–ù–ê–¶–ò–Ø –°–ï–ê–ù–°–ê</button>
            </div>

            <nav class="u-nav-bar">
                <div class="u-tab" onclick="Core.navigate('scr-hub')"><i>üì°</i><span>Hub</span></div>
                <div class="u-tab active" onclick="Core.navigate('scr-core')"><i>üõ°Ô∏è</i><span>Core</span></div>
            </nav>
        </section>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // [ –ì–õ–û–ë–ê–õ–¨–ù–´–ï –°–ò–°–¢–ï–ú–ù–´–ï –õ–û–ì–ò –î–õ–Ø –í–ï–°–ê –ö–û–î–ê ]
        console.log("%c MOROZOV ULTRA V20.0.0 INITIALIZED ", "background: #007aff; color: white; font-weight: bold; padding: 10px; border-radius: 5px;");
        console.warn("[SYSTEM]: KERNEL LOADED. ALL MODULES STANDING BY.");

        const FIREBASE_DATA = {
            apiKey: "AIzaSyDutfZZER58asyHr68zWlCx7B5k1adFhIk",
            authDomain: "morozov-ultra.firebaseapp.com",
            databaseURL: "https://morozov-ultra-default-rtdb.firebaseio.com",
            projectId: "morozov-ultra",
            storageBucket: "morozov-ultra.appspot.com",
            appId: "1:255345933856:web:5b8d1b93696f36eb5d4645"
        };

        const app = initializeApp(FIREBASE_DATA);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // [ THE CORE ENGINE CLASS ]
        class MorozovCore {
            constructor() {
                this.user = null;
                this.peer = null;
                this.room = null;
                this.initApp();
            }

            // --- UI TOOLS ---
            showToast(msg) {
                const t = document.getElementById('u-toast-sys');
                t.innerText = msg;
                t.classList.add('active');
                setTimeout(() => t.classList.remove('active'), 3500);
            }

            navigate(id) {
                document.querySelectorAll('.u-screen').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                console.log(`[NAV]: SCREEN CHANGED TO ${id}`);
            }

            updateTheme(t) {
                document.body.setAttribute('data-theme', t);
                document.querySelectorAll('.u-core-box').forEach(b => b.classList.remove('active'));
                document.getElementById(`th-${t}`).classList.add('active');
                this.showToast(`MATRIX: ${t.toUpperCase()}`);
            }

            // --- AUTH LOGIC ---
            async handleAuth() {
                const email = document.getElementById('auth-email').value;
                const pass = document.getElementById('auth-pass').value;
                const nick = document.getElementById('auth-nick').value;
                const log = document.getElementById('auth-log');

                if(!email || !pass) return this.showToast("DATA INCOMPLETE");
                log.innerText = "ESTABLISHING HANDSHAKE...";

                try {
                    await signInWithEmailAndPassword(auth, email, pass);
                    console.log("[AUTH]: SESSION RESTORED");
                } catch (e) {
                    if(nick) {
                        try {
                            const res = await createUserWithEmailAndPassword(auth, email, pass);
                            const nodeData = { id: nick, uid: res.user.uid, email: email, type: 'master' };
                            await set(ref(db, `mu_v20/nodes/${res.user.uid}`), nodeData);
                            await set(ref(db, `mu_v20/map/${nick}`), res.user.uid);
                            console.log("[AUTH]: NEW NODE REGISTERED");
                        } catch (err2) { log.innerText = `ERR: ${err2.message}`; }
                    } else { log.innerText = "ACCESS DENIED. PROVIDE CALLSIGN FOR REGISTRATION."; }
                }
            }

            // --- HUB LOGIC (–í –î–†) ---
            async scanAndLink() {
                const targetNick = document.getElementById('target-id').value.trim();
                if(!targetNick) return;

                this.showToast(`SCANNING FOR: ${targetNick}...`);

                const snap = await get(ref(db, `mu_v20/map/${targetNick}`));
                if(snap.exists()) {
                    const targetUid = snap.val();
                    if(targetUid === this.user.uid) return this.showToast("SELF-LINK PROHIBITED");

                    const updates = {};
                    updates[`mu_v20/friends/${this.user.uid}/${targetUid}`] = { id: targetNick, uid: targetUid };
                    updates[`mu_v20/friends/${targetUid}/${this.user.uid}`] = { id: this.user.id, uid: this.user.uid };
                    
                    await update(ref(db), updates);
                    document.getElementById('target-id').value = "";
                    this.showToast(`NODE ${targetNick} LINKED`);
                } else {
                    this.showToast("NODE NOT FOUND IN GRID");
                }
            }

            // --- CHAT LOGIC ---
            openChannel(peerData) {
                this.peer = peerData;
                this.room = [this.user.uid, peerData.uid].sort().join("___");
                
                document.getElementById('peer-title').innerHTML = `ULTRA <span>${peerData.id.toUpperCase()}</span>`;
                document.getElementById('peer-ava').innerText = peerData.id[0].toUpperCase();
                
                this.navigate('scr-chat');

                onValue(ref(db, `mu_v20/msgs/${this.room}`), (snapshot) => {
                    const stream = document.getElementById('msg-stream');
                    stream.innerHTML = "";
                    snapshot.forEach((child) => {
                        const m = child.val();
                        const div = document.createElement('div');
                        div.className = `u-msg ${m.sid === this.user.uid ? 'sent' : 'received'}`;
                        div.innerText = m.txt;
                        stream.appendChild(div);
                    });
                    stream.scrollTop = stream.scrollHeight;
                });
            }

            transmit() {
                const input = document.getElementById('msg-input');
                if(!input.value || !this.room) return;

                push(ref(db, `mu_v20/msgs/${this.room}`), {
                    sid: this.user.uid,
                    txt: input.value,
                    ts: Date.now()
                });
                input.value = "";
            }

            // --- SYSTEM SHUTDOWN ---
            emergencyExit() {
                if(confirm("TERMINATE SESSION?")) {
                    signOut(auth).then(() => location.reload());
                }
            }

            // --- INITIALIZATION ---
            initApp() {
                onAuthStateChanged(auth, (user) => {
                    if(user) {
                        onValue(ref(db, `mu_v20/nodes/${user.uid}`), (snap) => {
                            this.user = snap.val();
                            if(this.user) {
                                document.getElementById('my-nick-display').innerText = this.user.id;
                                document.getElementById('my-big-ava').innerText = this.user.id[0].toUpperCase();
                                
                                // Hide Preloader
                                document.getElementById('u-preloader').style.opacity = "0";
                                setTimeout(() => document.getElementById('u-preloader').style.display = "none", 1000);
                                
                                this.navigate('scr-hub');
                                this.showToast(`WELCOME BACK, ${this.user.id}`);

                                // Listen to Linked Nodes
                                onValue(ref(db, `mu_v20/friends/${user.uid}`), (fsnap) => {
                                    const list = document.getElementById('nodes-list');
                                    list.innerHTML = "";
                                    fsnap.forEach((child) => {
                                        const f = child.val();
                                        const card = document.createElement('div');
                                        card.className = "u-node-card";
                                        card.innerHTML = `
                                            <div class="u-ava-ring">${f.id[0].toUpperCase()}</div>
                                            <div class="u-node-meta">
                                                <h4>${f.id}</h4>
                                                <p>Linked / Active</p>
                                            </div>
                                        `;
                                        card.onclick = () => this.openChannel(f);
                                        list.appendChild(card);
                                    });
                                });
                            }
                        });
                    } else {
                        document.getElementById('u-preloader').style.display = "none";
                        this.navigate('scr-auth');
                    }
                });
            }
        }

        window.Core = new MorozovCore();

        // [ GLOBAL EVENT LISTENERS ]
        document.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') {
                const msgInput = document.getElementById('msg-input');
                const authPass = document.getElementById('auth-pass');
                if(document.activeElement === msgInput) Core.transmit();
                if(document.activeElement === authPass) Core.handleAuth();
            }
        });

    </script>
</body>
</html>
