<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ULTRA v20.0 | THE MONOLITH</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;700;900&display=swap" rel="stylesheet">

    <style>
        /* ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ДИЗАЙНА */
        :root {
            --bg: #010409;
            --surf: #0d1117;
            --brd: #30363d;
            --acc: #238636; /* Зеленый "титановый" акцент */
            --acc-hover: #2ea043;
            --blue: #2f81f7;
            --red: #da3633;
            --text-main: #c9d1d9;
            --text-dim: #8b949e;
            --glass: rgba(13, 17, 23, 0.8);
        }

        /* БАЗОВЫЕ СТИЛИ */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0; padding: 0;
            height: 100vh; width: 100vw;
            overflow: hidden;
            user-select: none;
        }

        /* СИСТЕМА ЭКРАНОВ */
        .u-screen {
            position: fixed; inset: 0;
            display: none; flex-direction: column;
            background: var(--bg);
            z-index: 10;
            animation: fadeIn 0.4s ease;
        }
        .u-screen.active { display: flex; z-index: 100; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ПОЛЯ ВВОДА В СТИЛЕ CYBERPUNK */
        .u-input {
            background: #010409;
            border: 1px solid var(--brd);
            padding: 18px 24px;
            border-radius: 16px;
            color: white;
            width: 100%;
            font-size: 16px;
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .u-input:focus {
            border-color: var(--blue);
            box-shadow: 0 0 20px rgba(47, 129, 247, 0.15);
            background: #0d1117;
        }

        /* КНОПКИ */
        .u-btn {
            padding: 18px 30px;
            border-radius: 16px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            cursor: pointer;
            transition: 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            border: none;
        }
        .btn-main { background: var(--blue); color: white; }
        .btn-main:hover { background: #4091ff; transform: translateY(-2px); }
        .btn-main:active { transform: translateY(0); }

        /* ЧАТ БАБЛЫ */
        .msg-container { display: flex; flex-direction: column; gap: 4px; margin-bottom: 12px; max-width: 85%; }
        .msg-me { align-self: flex-end; }
        .msg-he { align-self: flex-start; }

        .bubble {
            padding: 14px 18px;
            border-radius: 22px;
            font-size: 15px;
            line-height: 1.5;
            position: relative;
            word-wrap: break-word;
        }
        .bubble-me { 
            background: var(--blue); color: white; 
            border-bottom-right-radius: 4px;
            box-shadow: 0 4px 15px rgba(47, 129, 247, 0.2);
        }
        .bubble-he { 
            background: var(--surf); color: var(--text-main); 
            border: 1px solid var(--brd);
            border-bottom-left-radius: 4px;
        }

        /* МЕДИА-КОНТЕНТ */
        .media-wrap {
            margin-top: 8px;
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
            background: #000;
        }
        .media-wrap img, .media-wrap video { width: 100%; display: block; }

        /* ВИДЕО ЗВОНОК */
        #call-stage {
            position: fixed; inset: 0;
            background: #000;
            z-index: 1000;
            display: none;
        }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video {
            position: absolute; top: 40px; right: 20px;
            width: 120px; height: 180px;
            border-radius: 20px; border: 2px solid white;
            object-fit: cover; z-index: 1010;
            background: #111;
        }
        .call-controls {
            position: absolute; bottom: 40px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 20px;
            z-index: 1020;
        }
        .ctrl-btn {
            width: 65px; height: 65px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: white; cursor: pointer;
            backdrop-filter: blur(10px); background: rgba(255,255,255,0.1);
        }
        .ctrl-hangup { background: var(--red); }
    </style>
</head>
<body>

    <div id="scr-auth" class="u-screen active justify-center items-center px-6">
        <div class="w-full max-w-md">
            <div class="text-center mb-12">
                <div class="inline-block p-4 bg-blue-600 rounded-3xl mb-6 shadow-2xl shadow-blue-500/20">
                    <i class="fas fa-bolt text-4xl text-white"></i>
                </div>
                <h1 class="text-5xl font-black italic tracking-tighter">ULTRA <span class="text-blue-500">TITAN</span></h1>
                <p class="text-dim text-sm mt-2 font-mono uppercase tracking-widest">v20.0 Monolith Core</p>
            </div>

            <div class="bg-[var(--surf)] p-8 rounded-[40px] border border-[var(--brd)] shadow-2xl">
                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] font-bold uppercase text-dim ml-4 mb-2 block">Email Node</label>
                        <input id="inp-email" type="email" placeholder="name@domain.com" class="u-input">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold uppercase text-dim ml-4 mb-2 block">Access Key</label>
                        <input id="inp-pass" type="password" placeholder="••••••••" class="u-input">
                    </div>
                    <div id="box-nick">
                        <label class="text-[10px] font-bold uppercase text-dim ml-4 mb-2 block">Unique ID (New Users)</label>
                        <input id="inp-nick" type="text" placeholder="user_777" class="u-input">
                    </div>
                </div>

                <button id="btn-auth" onclick="App.Auth.execute()" class="u-btn btn-main w-full mt-8">
                    <span>Initialize Interface</span>
                    <i class="fas fa-chevron-right"></i>
                </button>
                
                <p id="auth-status" class="text-center mt-6 text-[10px] font-mono uppercase text-dim">System Standby</p>
            </div>
        </div>
    </div>

    <div id="scr-hub" class="u-screen">
        <header class="p-6 border-b border-[var(--brd)] flex justify-between items-center bg-[var(--surf)]/80 backdrop-blur-md">
            <div>
                <h2 class="text-xl font-black italic">MESH HUB</h2>
                <div id="label-my-id" class="text-blue-500 text-[10px] font-mono mt-1">NODE: ...</div>
            </div>
            <div class="flex gap-3">
                <button onclick="App.Hub.addAgent()" class="w-12 h-12 bg-white/5 border border-[var(--brd)] rounded-2xl flex items-center justify-center">
                    <i class="fas fa-user-plus text-sm"></i>
                </button>
                <button onclick="location.reload()" class="w-12 h-12 bg-red-500/10 text-red-500 border border-red-500/20 rounded-2xl flex items-center justify-center">
                    <i class="fas fa-power-off text-sm"></i>
                </button>
            </div>
        </header>

        <div id="contact-list" class="flex-1 overflow-y-auto p-6 space-y-3">
            </div>

        <nav class="p-4 border-t border-[var(--brd)] bg-[var(--surf)] flex justify-around">
            <i class="fas fa-comment-alt text-blue-500 text-xl"></i>
            <i class="fas fa-globe-americas text-dim text-xl"></i>
            <i class="fas fa-cog text-dim text-xl"></i>
        </nav>
    </div>

    <div id="scr-chat" class="u-screen">
        <header class="p-5 border-b border-[var(--brd)] flex items-center gap-4 bg-[var(--surf)]">
            <button onclick="App.Nav.go('hub')" class="w-10 h-10 flex items-center justify-center opacity-50"><i class="fas fa-arrow-left"></i></button>
            <div class="flex-1">
                <h3 id="chat-title" class="font-bold text-lg">Agent</h3>
                <div id="chat-status" class="text-[9px] uppercase font-black text-gray-500 tracking-tighter">Syncing...</div>
            </div>
            <div class="flex gap-2">
                <button onclick="App.Call.start(false)" class="w-11 h-11 bg-green-500/10 text-green-500 rounded-xl flex items-center justify-center"><i class="fas fa-phone-alt"></i></button>
                <button onclick="App.Call.start(true)" class="w-11 h-11 bg-blue-500/10 text-blue-500 rounded-xl flex items-center justify-center"><i class="fas fa-video"></i></button>
            </div>
        </header>

        <div id="chat-scroller" class="flex-1 overflow-y-auto p-5 flex flex-col">
            </div>

        <div class="p-4 bg-[var(--surf)] border-t border-[var(--brd)] pb-10">
            <div class="flex gap-3 items-center">
                <button onclick="document.getElementById('file-ptr').click()" class="w-12 h-12 text-dim text-xl"><i class="fas fa-paperclip"></i></button>
                <input type="file" id="file-ptr" class="hidden" accept="image/*,video/*" onchange="App.Chat.handleFile(this)">
                
                <div class="flex-1 relative">
                    <input id="msg-input" class="u-input !p-4" placeholder="Enter secure message...">
                </div>
                
                <button onclick="App.Chat.sendText()" class="w-14 h-14 bg-blue-600 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                    <i class="fas fa-paper-plane text-white"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="call-stage">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>
        
        <div class="call-controls">
            <button onclick="App.Call.toggleMic()" id="btn-mic" class="ctrl-btn"><i class="fas fa-microphone"></i></button>
            <button onclick="App.Call.switchCam()" class="ctrl-btn"><i class="fas fa-camera-rotate"></i></button>
            <button onclick="location.reload()" class="ctrl-btn ctrl-hangup"><i class="fas fa-phone-slash"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, get, update, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // КОНФИГУРАЦИЯ БАЗЫ (ТВОИ ДАННЫЕ)
        const fbConfig = {
            apiKey: "AIzaSyDutfZZER58asyHr68zWlCx7B5k1adFhIk",
            authDomain: "morozov-ultra.firebaseapp.com",
            databaseURL: "https://morozov-ultra-default-rtdb.firebaseio.com",
            projectId: "morozov-ultra",
            storageBucket: "morozov-ultra.appspot.com",
            appId: "1:255345933856:web:5b8d1b93696f36eb5d4645"
        };

        const FB_APP = initializeApp(fbConfig);
        const DB = getDatabase(FB_APP);
        const AUTH = getAuth(FB_APP);
        const STORE = getStorage(FB_APP);

        // ОБЪЕКТ ПРИЛОЖЕНИЯ - ВЕСЬ МОЗГ ТУТ
        window.App = {
            State: {
                Me: null,
                Partner: null,
                Room: null,
                RTC: null,
                Stream: null,
                Facing: "user",
                MicOn: true
            },

            Nav: {
                go: (screenId) => {
                    console.log("[NAV] Switching to:", screenId);
                    document.querySelectorAll('.u-screen').forEach(s => s.classList.remove('active'));
                    document.getElementById(`scr-${screenId}`).classList.add('active');
                }
            },

            Auth: {
                execute: async () => {
                    const e = document.getElementById('inp-email').value;
                    const p = document.getElementById('inp-pass').value;
                    const n = document.getElementById('inp-nick').value.trim();
                    const log = document.getElementById('auth-status');

                    if (!e || !p) return (log.innerText = "CREDENTIALS REQUIRED");
                    log.innerText = "CONNECTING TO MESH...";

                    try {
                        // Пытаемся войти
                        await signInWithEmailAndPassword(AUTH, e, p);
                    } catch (err) {
                        // Если нет акка - создаем
                        if (err.code === 'auth/user-not-found' || err.code === 'auth/invalid-credential') {
                            if (!n) return (log.innerText = "ID REQUIRED FOR NEW NODE");
                            try {
                                const res = await createUserWithEmailAndPassword(AUTH, e, p);
                                await set(ref(DB, `v20/users/${res.user.uid}`), { id: n, uid: res.user.uid, ts: Date.now() });
                                await set(ref(DB, `v20/map/${n}`), res.user.uid);
                            } catch (e2) { log.innerText = "REG ERROR: " + e2.message; }
                        } else { log.innerText = "AUTH ERROR: " + err.message; }
                    }
                }
            },

            Hub: {
                init: () => {
                    document.getElementById('label-my-id').innerText = "NODE: " + App.State.Me.id;
                    App.Hub.listenSocial();
                },

                addAgent: async () => {
                    const targetId = prompt("ENTER AGENT UNIQUE ID:");
                    if (!targetId) return;
                    
                    const snap = await get(ref(DB, `v20/map/${targetId}`));
                    if (snap.exists()) {
                        const targetUid = snap.val();
                        await update(ref(DB, `v20/social/${App.State.Me.uid}/${targetUid}`), { id: targetId, uid: targetUid });
                        await update(ref(DB, `v20/social/${targetUid}/${App.State.Me.uid}`), { id: App.State.Me.id, uid: App.State.Me.uid });
                    } else { alert("AGENT NOT FOUND IN GLOBAL MESH"); }
                },

                listenSocial: () => {
                    onValue(ref(DB, `v20/social/${App.State.Me.uid}`), snap => {
                        const list = document.getElementById('contact-list');
                        list.innerHTML = "";
                        snap.forEach(child => {
                            const data = child.val();
                            const div = document.createElement('div');
                            div.className = "p-5 bg-[var(--surf)] border border-[var(--brd)] rounded-3xl flex justify-between items-center active:scale-95 transition-all";
                            div.innerHTML = `
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-blue-500/20 rounded-2xl flex items-center justify-center text-blue-500 font-black">${data.id[0].toUpperCase()}</div>
                                    <div>
                                        <b class="text-white block">${data.id}</b>
                                        <span class="text-[9px] text-dim font-bold uppercase">Linked Node</span>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right opacity-20"></i>
                            `;
                            div.onclick = () => App.Chat.open(data);
                            list.appendChild(div);
                        });
                    });
                }
            },

            Chat: {
                open: (partner) => {
                    App.State.Partner = partner;
                    App.State.Room = [App.State.Me.uid, partner.uid].sort().join("_");
                    App.Nav.go('chat');
                    document.getElementById('chat-title').innerText = partner.id;
                    App.Chat.syncMessages();
                    App.Chat.monitorStatus();
                },

                monitorStatus: () => {
                    onValue(ref(DB, `v20/status/${App.State.Partner.uid}`), s => {
                        const label = document.getElementById('chat-status');
                        const isOnline = s.val() === "online";
                        label.innerText = isOnline ? "Active Connection" : "Last seen recently";
                        label.className = `text-[9px] uppercase font-black tracking-tighter ${isOnline ? 'text-green-500' : 'text-gray-500'}`;
                    });
                },

                syncMessages: () => {
                    onValue(ref(DB, `v20/rooms/${App.State.Room}`), snap => {
                        const feed = document.getElementById('chat-scroller');
                        feed.innerHTML = "";
                        snap.forEach(m => {
                            const d = m.val();
                            const isMe = d.sid === App.State.Me.uid;
                            
                            let contentHtml = "";
                            if (d.type === 'text') {
                                contentHtml = `<div class="bubble ${isMe ? 'bubble-me' : 'bubble-he'}">${d.txt}</div>`;
                            } else if (d.type === 'media') {
                                const mediaTag = d.fileType.includes('image') ? 
                                    `<img src="${d.url}" onclick="window.open('${d.url}')">` : 
                                    `<video src="${d.url}" controls></video>`;
                                contentHtml = `<div class="media-wrap ${isMe ? 'msg-me' : 'msg-he'}">${mediaTag}</div>`;
                            }

                            feed.innerHTML += `
                                <div class="msg-container ${isMe ? 'msg-me' : 'msg-he'}">
                                    ${contentHtml}
                                </div>
                            `;
                        });
                        feed.scrollTop = feed.scrollHeight;
                    });
                },

                sendText: () => {
                    const inp = document.getElementById('msg-input');
                    if (!inp.value.trim()) return;
                    push(ref(DB, `v20/rooms/${App.State.Room}`), {
                        sid: App.State.Me.uid,
                        txt: inp.value,
                        type: 'text',
                        ts: Date.now()
                    });
                    inp.value = "";
                },

                handleFile: async (el) => {
                    const file = el.files[0];
                    if (!file) return;
                    console.log("[STORAGE] Uploading:", file.name);
                    const path = `v20/media/${Date.now()}_${file.name}`;
                    const storageRef = sRef(STORE, path);
                    
                    try {
                        await uploadBytes(storageRef, file);
                        const url = await getDownloadURL(storageRef);
                        push(ref(DB, `v20/rooms/${App.State.Room}`), {
                            sid: App.State.Me.uid,
                            url: url,
                            type: 'media',
                            fileType: file.type,
                            ts: Date.now()
                        });
                    } catch (e) { alert("UPLOAD FAILED"); }
                }
            },

            Call: {
                start: async (useVideo) => {
                    console.log("[CALL] Initiating. Video:", useVideo);
                    document.getElementById('call-stage').style.display = 'block';
                    
                    try {
                        App.State.Stream = await navigator.mediaDevices.getUserMedia({
                            video: useVideo ? { facingMode: App.State.Facing } : false,
                            audio: true
                        });
                        
                        document.getElementById('local-video').srcObject = App.State.Stream;
                        
                        App.State.RTC = new RTCPeerConnection({
                            iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
                        });

                        App.State.Stream.getTracks().forEach(track => {
                            App.State.RTC.addTrack(track, App.State.Stream);
                        });

                        App.State.RTC.ontrack = (event) => {
                            document.getElementById('remote-video').srcObject = event.streams[0];
                        };

                        App.State.RTC.onicecandidate = (e) => {
                            if (e.candidate) {
                                push(ref(DB, `v20/calls/${App.State.Partner.uid}/ice`), e.candidate.toJSON());
                            }
                        };

                        const offer = await App.State.RTC.createOffer();
                        await App.State.RTC.setLocalDescription(offer);
                        
                        await set(ref(DB, `v20/calls/${App.State.Partner.uid}/sig`), {
                            offer: offer,
                            from: App.State.Me.uid,
                            fromId: App.State.Me.id,
                            video: useVideo
                        });

                        onValue(ref(DB, `v20/calls/${App.State.Partner.uid}/ans`), async snap => {
                            const ans = snap.val();
                            if (ans && !App.State.RTC.currentRemoteDescription) {
                                await App.State.RTC.setRemoteDescription(new RTCSessionDescription(ans));
                            }
                        });

                    } catch (err) {
                        console.error(err);
                        alert("MEDIA ACCESS DENIED");
                        location.reload();
                    }
                },

                listen: () => {
                    onValue(ref(DB, `v20/calls/${App.State.Me.uid}/sig`), async snap => {
                        const data = snap.val();
                        if (data && !App.State.RTC) {
                            if (confirm(`INCOMING CALL FROM ${data.fromId}`)) {
                                App.State.Partner = { uid: data.from, id: data.fromId };
                                await App.Call.start(data.video);
                                await App.State.RTC.setRemoteDescription(new RTCSessionDescription(data.offer));
                                const answer = await App.State.RTC.createAnswer();
                                await App.State.RTC.setLocalDescription(answer);
                                set(ref(DB, `v20/calls/${data.from}/ans`), answer);
                                
                                onValue(ref(DB, `v20/calls/${App.State.Me.uid}/ice`), iceSnap => {
                                    iceSnap.forEach(c => {
                                        App.State.RTC.addIceCandidate(new RTCIceCandidate(c.val()));
                                    });
                                });
                            } else {
                                remove(ref(DB, `v20/calls/${App.State.Me.uid}`));
                            }
                        }
                    });
                },

                toggleMic: () => {
                    App.State.MicOn = !App.State.MicOn;
                    App.State.Stream.getAudioTracks()[0].enabled = App.State.MicOn;
                    document.getElementById('btn-mic').style.color = App.State.MicOn ? 'white' : 'red';
                },

                switchCam: async () => {
                    App.State.Facing = App.State.Facing === "user" ? "environment" : "user";
                    if (App.State.Stream) {
                        App.State.Stream.getTracks().forEach(t => t.stop());
                        App.State.Stream = await navigator.mediaDevices.getUserMedia({
                            video: { facingMode: App.State.Facing },
                            audio: true
                        });
                        document.getElementById('local-video').srcObject = App.State.Stream;
                        const videoTrack = App.State.Stream.getVideoTracks()[0];
                        const sender = App.State.RTC.getSenders().find(s => s.track.kind === "video");
                        if (sender) sender.replaceTrack(videoTrack);
                    }
                }
            }
        };

        // ГЛОБАЛЬНЫЙ СЛУШАТЕЛЬ СОСТОЯНИЯ AUTH
        onAuthStateChanged(AUTH, user => {
            if (user) {
                onValue(ref(DB, `v20/users/${user.uid}`), snap => {
                    App.State.Me = snap.val();
                    if (App.State.Me) {
                        App.Nav.go('hub');
                        App.Hub.init();
                        App.Call.listen();
                        // Статус онлайн
                        const statusRef = ref(DB, `v20/status/${user.uid}`);
                        set(statusRef, "online");
                        onDisconnect(statusRef).set("offline");
                    }
                });
            } else {
                App.Nav.go('auth');
            }
        });

        console.log("[SYSTEM] TITAN MONOLITH CORE INITIALIZED");
    </script>
</body>
</html>
