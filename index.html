<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Morozov Ultra</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* ============================================================
           ГЛОБАЛЬНАЯ КОНФИГУРАЦИЯ ЦВЕТОВ И ТЕМ
           ============================================================ */
        :root {
            --titan-bg: #010204;
            --titan-surface: #0d1117;
            --titan-border: #30363d;
            --titan-accent: #2f81f7;
            --titan-text: #c9d1d9;
            --titan-text-muted: #8b949e;
            --titan-error: #f85149;
            --titan-success: #3fb950;
            --titan-glow: rgba(47, 129, 247, 0.4);
        }

        /* ТЕМА DEEP NIGHT (АБСОЛЮТНЫЙ ЧЕРНЫЙ) */
        body.deep-night {
            --titan-bg: #000000;
            --titan-surface: #050505;
            --titan-border: #1a1a1a;
            --titan-accent: #ffffff;
            --titan-text: #ffffff;
            --titan-glow: rgba(255, 255, 255, 0.2);
        }

        /* БАЗОВЫЕ ПРАВИЛА И ОПТИМИЗАЦИЯ */
        * {
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
                        border-color 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                        transform 0.2s ease;
        }

        body {
            background-color: var(--titan-bg);
            color: var(--titan-text);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            -webkit-user-select: none;
            user-select: none;
        }

        /* ============================================================
           СИСТЕМА ЭКРАНОВ (SCREENS)
           ============================================================ */
        .titan-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            flex-direction: column;
            background: var(--titan-bg);
            z-index: 10;
        }

        .titan-screen.active {
            display: flex;
            z-index: 100;
            animation: titanScreenEntry 0.5s cubic-bezier(0.22, 1, 0.36, 1);
        }

        @keyframes titanScreenEntry {
            from { opacity: 0; transform: translateY(10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* ============================================================
           КАСТОМНЫЙ ИНТЕРФЕЙС (UI COMPONENTS)
           ============================================================ */
        
        /* ПОЛЯ ВВОДА */
        .titan-input {
            background: rgba(255, 255, 255, 0.02);
            border: 2px solid var(--titan-border);
            padding: 22px;
            border-radius: 24px;
            color: #ffffff;
            font-size: 16px;
            width: 100%;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .titan-input:focus {
            border-color: var(--titan-accent);
            background: var(--titan-surface);
            box-shadow: 0 0 25px var(--titan-glow);
        }

        /* КНОПКИ */
        .titan-btn-primary {
            background: var(--titan-accent);
            color: #000000;
            padding: 22px;
            border-radius: 24px;
            font-weight: 900;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
            border: none;
            cursor: pointer;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        body:not(.deep-night) .titan-btn-primary {
            color: #ffffff;
        }

        .titan-btn-primary:active {
            transform: scale(0.96);
            filter: brightness(0.9);
        }

        /* МОДАЛЬНЫЕ ОКНА (CUSTOM MODALS) */
        #titan-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .titan-modal-box {
            background: var(--titan-surface);
            border: 1px solid var(--titan-border);
            width: 100%;
            max-width: 420px;
            padding: 40px;
            border-radius: 40px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.6);
            animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalPop {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }

        /* ЧАТОВЫЕ ПУЗЫРИ */
        .msg-feed {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .bubble {
            max-width: 80%;
            padding: 18px 24px;
            border-radius: 28px;
            font-size: 15px;
            line-height: 1.5;
            position: relative;
        }

        .bubble-me {
            align-self: flex-end;
            background: var(--titan-accent);
            color: #000;
            border-bottom-right-radius: 4px;
        }

        body:not(.deep-night) .bubble-me { color: #fff; }

        .bubble-peer {
            align-self: flex-start;
            background: var(--titan-surface);
            border: 1px solid var(--titan-border);
            color: var(--titan-text);
            border-bottom-left-radius: 4px;
        }

        /* НИЖНЯЯ ПАНЕЛЬ (TAB BAR) */
        .titan-tab-bar {
            height: 90px;
            background: var(--titan-surface);
            border-top: 1px solid var(--titan-border);
            display: flex;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .tab-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--titan-text-muted);
            font-size: 10px;
            font-weight: 800;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .tab-item.active {
            color: var(--titan-accent);
        }

        .tab-item i {
            font-size: 24px;
            margin-bottom: 6px;
        }

        /* ИНТЕРФЕЙС ВЫЗОВА */
        #titan-call-module {
            position: fixed;
            inset: 0;
            background: #000000;
            z-index: 10000;
            display: none;
            flex-direction: column;
        }

        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video {
            position: absolute;
            top: 60px;
            right: 30px;
            width: 120px;
            height: 180px;
            border-radius: 24px;
            border: 2px solid rgba(255,255,255,0.2);
            object-fit: cover;
            background: #111;
        }
    </style>
</head>
<body id="titan-body-root">

    <div id="titan-modal-overlay">
        <div class="titan-modal-box">
            <h2 id="modal-title" class="text-3xl font-black mb-6 uppercase italic tracking-tighter">System Request</h2>
            <div id="modal-body-content">
                <input type="text" id="modal-input-field" class="titan-input" placeholder="Value...">
            </div>
            <div class="flex gap-4 mt-4">
                <button onclick="TitanApp.Interface.hideModal()" class="flex-1 p-5 rounded-3xl bg-white/5 font-bold uppercase text-xs">Cancel</button>
                <button id="modal-btn-confirm" class="flex-1 titan-btn-primary !p-5 !text-xs">Execute</button>
            </div>
        </div>
    </div>

    <div id="screen-auth" class="titan-screen active justify-center items-center px-10">
        <div class="w-full max-w-sm text-center">
            <h1 class="text-7xl font-black italic mb-2 tracking-tighter text-white">TITAN</h1>
            <p class="text-[10px] font-bold text-blue-500 uppercase tracking-[0.5em] mb-12">Monolith Enterprise v32.0</p>
            
            <div class="space-y-2">
                <input id="auth-email" type="email" class="titan-input" placeholder="Email Address" value="egorkamorozoff2014@gmail.com">
                <input id="auth-pass" type="password" class="titan-input" placeholder="Security Password">
                <input id="auth-nick" type="text" class="titan-input" placeholder="Node Identity (New Users Only)">
                <button onclick="TitanApp.Core.handleAuthentication()" class="titan-btn-primary mt-4">Initialize Session</button>
            </div>
            
            <p id="auth-status-log" class="mt-8 text-[10px] font-bold text-gray-600 uppercase tracking-widest italic">Awaiting System Handshake...</p>
        </div>
    </div>

    <div id="screen-hub" class="titan-screen">
        <header class="p-8 border-b border-[var(--titan-border)] flex justify-between items-center bg-[var(--titan-surface)]">
            <div>
                <h2 class="text-2xl font-black italic uppercase tracking-tighter">Mesh Hub</h2>
                <div id="hub-identity-display" class="text-[10px] text-blue-500 font-mono mt-1 font-bold tracking-widest uppercase">ID: CONNECTING...</div>
            </div>
            <button onclick="TitanApp.Social.showAddContactDialog()" class="w-14 h-14 bg-blue-600 rounded-3xl flex items-center justify-center shadow-xl active:scale-90 transition">
                <i class="fas fa-plus text-white text-xl"></i>
            </button>
        </header>

        <div id="hub-contacts-list" class="flex-1 overflow-y-auto p-6 space-y-4">
            </div>

        <nav class="titan-tab-bar">
            <div class="tab-item active" onclick="TitanApp.Interface.switchScreen('hub')">
                <i class="fas fa-comment-dots"></i>
                <span>Messages</span>
            </div>
            <div class="tab-item" onclick="TitanApp.Interface.switchScreen('settings')">
                <i class="fas fa-shield-halved"></i>
                <span>Security</span>
            </div>
        </nav>
    </div>

    <div id="screen-chat" class="titan-screen">
        <header class="p-6 border-b border-[var(--titan-border)] flex items-center gap-5 bg-[var(--titan-surface)]">
            <button onclick="TitanApp.Interface.switchScreen('hub')" class="text-xl opacity-30 active:opacity-100 transition">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="flex-1">
                <h3 id="chat-peer-id" class="text-xl font-bold tracking-tight italic">Node Agent</h3>
                <div class="text-[9px] text-green-500 font-black uppercase tracking-widest">End-to-End Encrypted</div>
            </div>
            <div class="flex gap-4">
                <button onclick="TitanApp.Media.startCall(false)" class="w-12 h-12 bg-white/5 rounded-2xl flex items-center justify-center opacity-40"><i class="fas fa-phone-alt"></i></button>
                <button onclick="TitanApp.Media.startCall(true)" class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg"><i class="fas fa-video"></i></button>
            </div>
        </header>

        <div id="chat-messages-feed" class="msg-feed">
            </div>

        <div class="p-6 bg-[var(--titan-surface)] border-t border-[var(--titan-border)] flex gap-4 items-center pb-12">
            <button onclick="document.getElementById('file-upload-input').click()" class="text-2xl opacity-20"><i class="fas fa-paperclip"></i></button>
            <input type="file" id="file-upload-input" class="hidden" onchange="TitanApp.Media.uploadFile(this)">
            
            <input id="chat-input-message" class="titan-input !mb-0 !p-5 flex-1" placeholder="Enter encrypted signal...">
            
            <button onclick="TitanApp.Chat.broadcastMessage()" class="w-16 h-16 bg-blue-600 rounded-3xl flex items-center justify-center shadow-2xl">
                <i class="fas fa-paper-plane text-xl"></i>
            </button>
        </div>
    </div>

    <div id="screen-settings" class="titan-screen">
        <header class="p-10 border-b border-[var(--titan-border)]">
            <h2 class="text-4xl font-black italic uppercase tracking-tighter">Core Config</h2>
        </header>

        <div class="flex-1 overflow-y-auto">
            <div class="p-12 text-center border-b border-[var(--titan-border)]">
                <div id="set-avatar-box" class="w-28 h-28 bg-blue-600 rounded-[45px] mx-auto mb-6 flex items-center justify-center text-5xl font-black shadow-2xl text-white">?</div>
                <h3 id="set-id-display" class="text-3xl font-bold tracking-tight">User Identity</h3>
                <p id="set-email-display" class="text-gray-500 font-mono text-sm mt-2">node@titan.net</p>
            </div>

            <div class="p-8 space-y-5">
                <div class="p-7 bg-[var(--titan-surface)] rounded-[35px] border border-[var(--titan-border)] flex justify-between items-center">
                    <div>
                        <b class="text-lg block italic">Deep Night Mode</b>
                        <span class="text-xs text-gray-500 uppercase font-black tracking-widest">Maximum Darkness</span>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="theme-switch" class="sr-only peer" onchange="TitanApp.Interface.toggleNightMode(this.checked)">
                        <div class="w-14 h-8 bg-gray-700 rounded-full peer peer-checked:bg-white transition-all after:content-[''] after:absolute after:top-1 after:left-1 after:bg-gray-400 after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:after:translate-x-6 peer-checked:after:bg-black"></div>
                    </label>
                </div>

                <button onclick="TitanApp.Social.showChangeNicknameDialog()" class="w-full p-7 bg-[var(--titan-surface)] rounded-[35px] border border-[var(--titan-border)] text-left flex justify-between items-center active:scale-95">
                    <div>
                        <b class="text-lg block italic">Modify Global ID</b>
                        <span class="text-xs text-gray-500 uppercase font-black tracking-widest">Update Mesh Alias</span>
                    </div>
                    <i class="fas fa-fingerprint text-blue-500 text-2xl"></i>
                </button>

                <button onclick="location.reload()" class="w-full p-8 bg-red-600/10 text-red-500 rounded-[40px] border border-red-500/20 font-black uppercase tracking-[0.3em] mt-10 shadow-xl active:scale-95 transition">
                    Terminate Session
                </button>
            </div>
        </div>

        <nav class="titan-tab-bar">
            <div class="tab-item" onclick="TitanApp.Interface.switchScreen('hub')">
                <i class="fas fa-comment-dots"></i>
                <span>Messages</span>
            </div>
            <div class="tab-item active" onclick="TitanApp.Interface.switchScreen('settings')">
                <i class="fas fa-shield-halved"></i>
                <span>Security</span>
            </div>
        </nav>
    </div>

    <div id="titan-call-module">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>
        
        <div class="absolute bottom-16 left-0 w-full flex justify-center gap-10 z-[10001]">
            <button onclick="TitanApp.Media.toggleMic()" id="call-mic-btn" class="w-20 h-20 rounded-full bg-white/10 backdrop-blur-xl border border-white/20 text-2xl">
                <i class="fas fa-microphone"></i>
            </button>
            <button onclick="location.reload()" class="w-24 h-24 rounded-full bg-red-600 text-3xl shadow-2xl shadow-red-600/40 active:scale-90">
                <i class="fas fa-phone-slash"></i>
            </button>
            <button onclick="TitanApp.Media.flipCam()" class="w-20 h-20 rounded-full bg-white/10 backdrop-blur-xl border border-white/20 text-2xl">
                <i class="fas fa-camera-rotate"></i>
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, get, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // КОНФИГУРАЦИЯ FIREBASE (ТВОИ ДАННЫЕ)
        const FB_CONFIG = {
            apiKey: "AIzaSyDutfZZER58asyHr68zWlCx7B5k1adFhIk",
            authDomain: "morozov-ultra.firebaseapp.com",
            databaseURL: "https://morozov-ultra-default-rtdb.firebaseio.com",
            projectId: "morozov-ultra",
            storageBucket: "morozov-ultra.appspot.com",
            appId: "1:255345933856:web:5b8d1b93696f36eb5d4645"
        };

        const APP = initializeApp(FB_CONFIG);
        const DB = getDatabase(APP);
        const AUTH = getAuth(APP);
        const STORAGE = getStorage(APP);

        // ОБЪЕКТ УПРАВЛЕНИЯ ПРИЛОЖЕНИЕМ
        window.TitanApp = {
            State: {
                User: null,
                ActivePartner: null,
                RoomID: null,
                RTC_Connection: null,
                Stream: null,
                CamMode: 'user',
                MicActive: true
            },

            // ИНТЕРФЕЙСНЫЙ КОНТРОЛЛЕР
            Interface: {
                switchScreen: (id) => {
                    document.querySelectorAll('.titan-screen').forEach(s => s.classList.remove('active'));
                    document.getElementById(`screen-${id}`).classList.add('active');
                },

                showModal: (title, placeholder, onConfirm) => {
                    const overlay = document.getElementById('titan-modal-overlay');
                    const input = document.getElementById('modal-input-field');
                    document.getElementById('modal-title').innerText = title;
                    input.placeholder = placeholder;
                    input.value = "";
                    overlay.style.display = 'flex';
                    document.getElementById('modal-btn-confirm').onclick = () => {
                        onConfirm(input.value);
                        TitanApp.Interface.hideModal();
                    };
                },

                hideModal: () => document.getElementById('titan-modal-overlay').style.display = 'none',

                toggleNightMode: (isEnabled) => {
                    document.getElementById('titan-body-root').className = isEnabled ? 'deep-night' : '';
                    localStorage.setItem('titan_v32_theme', isEnabled ? 'night' : 'day');
                }
            },

            // ЯДРО АВТОРИЗАЦИИ
            Core: {
                handleAuthentication: async () => {
                    const email = document.getElementById('auth-email').value;
                    const pass = document.getElementById('auth-pass').value;
                    const nick = document.getElementById('auth-nick').value.trim();
                    const log = document.getElementById('auth-status-log');

                    if (!email || !pass) return;
                    log.innerText = "Synchronizing with Mesh...";

                    try {
                        await signInWithEmailAndPassword(AUTH, email, pass);
                    } catch (err) {
                        if (nick) {
                            log.innerText = "Registering New Node Identity...";
                            try {
                                const res = await createUserWithEmailAndPassword(AUTH, email, pass);
                                const uData = { id: nick, uid: res.user.uid, email: email, ts: Date.now() };
                                await set(ref(DB, `v32/users/${res.user.uid}`), uData);
                                await set(ref(DB, `v32/map/${nick}`), res.user.uid);
                            } catch (regErr) { log.innerText = "Error: " + regErr.message; }
                        } else { log.innerText = "Identity ID Required for New Nodes"; }
                    }
                }
            },

            // СОЦИАЛЬНАЯ ЛОГИКА
            Social: {
                showAddContactDialog: () => {
                    TitanApp.Interface.showModal("Link Node", "Enter Target ID", async (val) => {
                        if (!val) return;
                        const snap = await get(ref(DB, `v32/map/${val}`));
                        if (snap.exists()) {
                            const targetUid = snap.val();
                            await update(ref(DB, `v32/social/${TitanApp.State.User.uid}/${targetUid}`), { id: val, uid: targetUid });
                            await update(ref(DB, `v32/social/${targetUid}/${TitanApp.State.User.uid}`), { id: TitanApp.State.User.id, uid: TitanApp.State.User.uid });
                        } else { alert("Node Signal Not Found."); }
                    });
                },

                showChangeNicknameDialog: () => {
                    TitanApp.Interface.showModal("Alias Update", "Enter New Global ID", async (val) => {
                        if (!val) return;
                        const uid = TitanApp.State.User.uid;
                        await update(ref(DB, `v32/users/${uid}`), { id: val });
                        await set(ref(DB, `v32/map/${val}`), uid);
                        location.reload();
                    });
                }
            },

            // ЛОГИКА ЧАТА
            Chat: {
                openRoom: (partner) => {
                    TitanApp.State.ActivePartner = partner;
                    TitanApp.State.RoomID = [TitanApp.State.User.uid, partner.uid].sort().join("_");
                    TitanApp.Interface.switchScreen('chat');
                    document.getElementById('chat-peer-id').innerText = partner.id;

                    onValue(ref(DB, `v32/rooms/${TitanApp.State.RoomID}`), snap => {
                        const f = document.getElementById('chat-messages-feed');
                        f.innerHTML = "";
                        snap.forEach(m => {
                            const d = m.val();
                            const isMe = d.sid === TitanApp.State.User.uid;
                            f.innerHTML += `<div class="bubble ${isMe ? 'bubble-me' : 'bubble-peer'}">${d.txt}</div>`;
                        });
                        f.scrollTop = f.scrollHeight;
                    });
                },

                broadcastMessage: () => {
                    const input = document.getElementById('chat-input-message');
                    if (!input.value.trim()) return;
                    push(ref(DB, `v32/rooms/${TitanApp.State.RoomID}`), {
                        sid: TitanApp.State.User.uid,
                        txt: input.value,
                        ts: Date.now()
                    });
                    input.value = "";
                }
            },

            // МЕДИА И ЗВОНКИ (WEBRTC)
            Media: {
                startCall: async (vid) => {
                    document.getElementById('titan-call-module').style.display = 'flex';
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ video: vid, audio: true });
                        TitanApp.State.Stream = stream;
                        document.getElementById('local-video').srcObject = stream;
                        
                        TitanApp.State.RTC_Connection = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
                        stream.getTracks().forEach(t => TitanApp.State.RTC_Connection.addTrack(t, stream));

                        TitanApp.State.RTC_Connection.ontrack = e => {
                            document.getElementById('remote-video').srcObject = e.streams[0];
                        };

                        TitanApp.State.RTC_Connection.onicecandidate = e => {
                            if (e.candidate) {
                                push(ref(DB, `v32/calls/${TitanApp.State.ActivePartner.uid}/ice`), e.candidate.toJSON());
                            }
                        };

                        const offer = await TitanApp.State.RTC_Connection.createOffer();
                        await TitanApp.State.RTC_Connection.setLocalDescription(offer);
                        
                        set(ref(DB, `v32/calls/${TitanApp.State.ActivePartner.uid}/signal`), {
                            offer, vid, from: TitanApp.State.User.uid, fromId: TitanApp.State.User.id
                        });

                        onValue(ref(DB, `v32/calls/${TitanApp.State.User.uid}/ans`), async s => {
                            const d = s.val();
                            if (d && !TitanApp.State.RTC_Connection.currentRemoteDescription) {
                                await TitanApp.State.RTC_Connection.setRemoteDescription(new RTCSessionDescription(d));
                            }
                        });
                    } catch (e) { location.reload(); }
                },

                toggleMic: () => {
                    TitanApp.State.MicActive = !TitanApp.State.MicActive;
                    TitanApp.State.Stream.getAudioTracks()[0].enabled = TitanApp.State.MicActive;
                    document.getElementById('call-mic-btn').style.color = TitanApp.State.MicActive ? 'white' : 'red';
                },

                flipCam: async () => {
                    TitanApp.State.CamMode = TitanApp.State.CamMode === 'user' ? 'environment' : 'user';
                    TitanApp.State.Stream.getTracks().forEach(t => t.stop());
                    const nStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: TitanApp.State.CamMode }, audio: true });
                    TitanApp.State.Stream = nStream;
                    document.getElementById('local-video').srcObject = nStream;
                    const vTrack = nStream.getVideoTracks()[0];
                    const sender = TitanApp.State.RTC_Connection.getSenders().find(s => s.track.kind === 'video');
                    if (sender) sender.replaceTrack(vTrack);
                }
            }
        };

        // ЖИЗНЕННЫЙ ЦИКЛ ПРИЛОЖЕНИЯ
        onAuthStateChanged(AUTH, user => {
            if (user) {
                onValue(ref(DB, `v32/users/${user.uid}`), snap => {
                    TitanApp.State.User = snap.val();
                    if (TitanApp.State.User) {
                        TitanApp.Interface.switchScreen('hub');
                        document.getElementById('hub-identity-display').innerText = "ID: " + TitanApp.State.User.id;
                        document.getElementById('set-id-display').innerText = TitanApp.State.User.id;
                        document.getElementById('set-email-display').innerText = TitanApp.State.User.email;
                        document.getElementById('set-avatar-box').innerText = TitanApp.State.User.id[0].toUpperCase();

                        // Слушатель контактов
                        onValue(ref(DB, `v32/social/${user.uid}`), s => {
                            const list = document.getElementById('hub-contacts-list');
                            list.innerHTML = "";
                            s.forEach(c => {
                                const d = c.val();
                                const el = document.createElement('div');
                                el.className = "p-7 bg-[var(--titan-surface)] rounded-[35px] border border-[var(--titan-border)] flex justify-between items-center font-bold active:scale-95 transition cursor-pointer shadow-lg";
                                el.innerHTML = `<span>${d.id}</span><i class="fas fa-chevron-right opacity-10"></i>`;
                                el.onclick = () => TitanApp.Chat.openRoom(d);
                                list.appendChild(el);
                            });
                        });

                        // Слушатель звонков
                        onValue(ref(DB, `v32/calls/${user.uid}/signal`), async s => {
                            const d = s.val();
                            if (d && !TitanApp.State.RTC_Connection) {
                                TitanApp.Interface.showModal("Incoming Signal", "Accept call from " + d.fromId + "? Type YES", async (v) => {
                                    if (v.toUpperCase() === 'YES') {
                                        TitanApp.State.ActivePartner = { uid: d.from, id: d.fromId };
                                        await TitanApp.Media.startCall(d.vid);
                                        await TitanApp.State.RTC_Connection.setRemoteDescription(new RTCSessionDescription(d.offer));
                                        const ans = await TitanApp.State.RTC_Connection.createAnswer();
                                        await TitanApp.State.RTC_Connection.setLocalDescription(ans);
                                        set(ref(DB, `v32/calls/${d.from}/ans`), ans);
                                    } else { remove(ref(DB, `v32/calls/${user.uid}`)); }
                                });
                            }
                        });
                    }
                });
            } else {
                TitanApp.Interface.switchScreen('auth');
            }
        });

        // ПРОВЕРКА СОХРАНЕННОЙ ТЕМЫ
        if (localStorage.getItem('titan_v32_theme') === 'night') {
            TitanApp.Interface.toggleNightMode(true);
            document.getElementById('theme-switch').checked = true;
        }

        console.log("TITAN GIGA-MONOLITH v32.0 LOADED");
    </script>
</body>
</html>
