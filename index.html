<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>MOROZOV ULTRA | V25.0</title>

    <style>
        /* [ SECTION 1: GLOBAL DESIGN SYSTEM ] */
        :root {
            --bg: #000000;
            --surface: #0c0c0e;
            --card: #18181b;
            --accent: #007aff;
            --accent-glow: rgba(0, 122, 255, 0.4);
            --text-main: #ffffff;
            --text-sec: #8e8e93;
            --border: rgba(255,255,255,0.1);
            --safe-t: env(safe-area-inset-top);
            --safe-b: env(safe-area-inset-bottom);
            --anim-speed: 0.3s;
        }

        /* [ SECTION 2: RESET & LAYOUT ] */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background: var(--bg); color: var(--text-main); 
            font-family: -apple-system, system-ui, sans-serif; 
            overflow: hidden; height: 100vh; width: 100vw;
        }

        .mu-viewport {
            position: absolute; inset: 0; display: none; flex-direction: column;
            background: var(--bg); z-index: 10;
        }
        .mu-viewport.active { display: flex; animation: slideUp var(--anim-speed) cubic-bezier(0.1, 0.7, 0.1, 1); }

        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* [ SECTION 3: HEADER & NAVIGATION ] */
        .mu-header {
            padding: calc(var(--safe-t) + 15px) 20px 15px;
            background: var(--surface); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
        }
        .mu-logo { font-size: 22px; font-weight: 900; letter-spacing: -1.5px; text-transform: uppercase; }
        .mu-logo span { color: var(--accent); text-shadow: 0 0 10px var(--accent-glow); }

        .mu-nav {
            height: 85px; background: var(--surface); border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; padding-bottom: var(--safe-b);
        }
        .mu-nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-sec); cursor: pointer; }
        .mu-nav-btn.active { color: var(--accent); }
        .mu-nav-btn i { font-style: normal; font-size: 24px; margin-bottom: 4px; }
        .mu-nav-btn span { font-size: 10px; font-weight: 800; text-transform: uppercase; }

        /* [ SECTION 4: CHAT ENGINE UI ] */
        .chat-flow { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        
        .msg { 
            max-width: 80%; padding: 12px 16px; border-radius: 20px; font-size: 16px; 
            line-height: 1.4; position: relative; word-wrap: break-word;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .msg.sent { align-self: flex-end; background: var(--accent); color: white; border-bottom-right-radius: 4px; }
        .msg.received { align-self: flex-start; background: var(--card); border: 1px solid var(--border); border-bottom-left-radius: 4px; }

        /* –ú–µ–¥–∏–∞-–∫–æ–Ω—Ç–µ–Ω—Ç –≤ —á–∞—Ç–µ */
        .msg-img { width: 100%; border-radius: 12px; margin-top: 5px; display: block; border: 1px solid rgba(255,255,255,0.1); }
        .msg-video { width: 100%; border-radius: 12px; margin-top: 5px; background: #000; }
        .msg-sticker { font-size: 60px; background: transparent !important; box-shadow: none !important; padding: 0 !important; }
        .msg-audio { min-width: 200px; padding: 10px; display: flex; align-items: center; gap: 10px; }

        /* [ SECTION 5: INPUT SYSTEM & ATTACHMENTS ] */
        .input-panel {
            padding: 10px 15px calc(var(--safe-b) + 10px);
            background: var(--surface); border-top: 1px solid var(--border);
            display: flex; align-items: center; gap: 10px;
        }
        .field-wrap { flex: 1; background: var(--card); border-radius: 25px; display: flex; align-items: center; padding: 0 15px; border: 1px solid var(--border); }
        .field { flex: 1; background: transparent; border: none; padding: 12px 0; color: white; font-size: 16px; outline: none; }
        
        .action-btn { width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; border-radius: 50%; }
        .action-btn:active { background: var(--border); transform: scale(0.9); }
        .action-btn.rec { color: #ff3b30; animation: pulse 1s infinite; }

        @keyframes pulse { 50% { opacity: 0.5; } }

        /* –ü–∞–Ω–µ–ª—å —Å—Ç–∏–∫–µ—Ä–æ–≤ –∏ –≤–ª–æ–∂–µ–Ω–∏–π */
        .extra-panel { display: none; background: var(--surface); border-top: 1px solid var(--border); height: 260px; overflow-y: auto; padding: 20px; }
        .sticker-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .stk-item { font-size: 45px; text-align: center; cursor: pointer; transition: 0.2s; }
        .stk-item:hover { transform: scale(1.2); }

        /* [ SECTION 6: CALL INTERFACE ] */
        .call-ui {
            position: fixed; inset: 0; background: radial-gradient(circle at center, #1c1c1e 0%, #000 100%);
            z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: space-around;
            padding: 80px 0;
        }
        .call-ui.active { display: flex; }
        .call-avatar { 
            width: 140px; height: 140px; background: var(--accent); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 60px; font-weight: 900;
            box-shadow: 0 0 40px var(--accent-glow);
        }
        .call-btn-group { display: flex; gap: 40px; }
        .c-btn { width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; }
        .c-btn.decline { background: #ff3b30; }
        .c-btn.accept { background: #34c759; }

        /* [ SECTION 7: LISTS & CARDS ] */
        .node-list { flex: 1; overflow-y: auto; padding: 15px; }
        .node-card {
            background: var(--card); padding: 15px; border-radius: 18px; margin-bottom: 12px;
            display: flex; align-items: center; gap: 15px; border: 1px solid var(--border);
            transition: 0.2s;
        }
        .node-card:active { transform: scale(0.97); background: var(--surface); }
        .node-ava { width: 55px; height: 55px; background: var(--accent); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 22px; }

    </style>
</head>
<body>

    <div id="call-screen" class="call-ui">
        <div class="call-avatar" id="c-ava">?</div>
        <div style="text-align: center;">
            <h2 id="c-name" style="font-size: 32px;">User</h2>
            <p id="c-status" style="color: var(--accent); margin-top: 10px; font-weight: 800; letter-spacing: 2px;">–í–•–û–î–Ø–©–ò–ô –í–´–ó–û–í</p>
        </div>
        <div class="call-btn-group">
            <div class="c-btn decline" onclick="Engine.Call.end()">‚úñ</div>
            <div class="c-btn accept" onclick="Engine.Call.answer()">‚úî</div>
        </div>
    </div>

    <section id="scr-auth" class="mu-viewport active">
        <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 40px;">
            <div class="mu-logo" style="font-size: 40px; text-align: center; margin-bottom: 50px;">MOROZOV <span>ULTRA</span></div>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <input type="email" id="auth-email" class="field" style="background: var(--card); border-radius: 15px; padding: 20px;" placeholder="Email" value="egorkamorozoff2014@gmail.com">
                <input type="password" id="auth-pass" class="field" style="background: var(--card); border-radius: 15px; padding: 20px;" placeholder="–ü–∞—Ä–æ–ª—å">
                <input type="text" id="auth-nick" class="field" style="background: var(--card); border-radius: 15px; padding: 20px;" placeholder="–ù–∏–∫–Ω–µ–π–º">
                <button onclick="Engine.Auth.process()" style="height: 65px; border-radius: 15px; background: var(--accent); color: white; border: none; font-weight: 900; font-size: 18px; margin-top: 20px;">–í–û–ô–¢–ò –í –°–ï–¢–¨</button>
            </div>
        </div>
    </section>

    <section id="scr-hub" class="mu-viewport">
        <header class="mu-header">
            <div class="mu-logo">ULTRA <span>HUB</span></div>
            <div class="action-btn" onclick="Engine.Router.go('scr-core')">‚öôÔ∏è</div>
        </header>
        <div style="padding: 15px;">
            <div class="field-wrap" style="height: 60px; border-radius: 15px;">
                <input type="text" id="find-node" class="field" placeholder="–ü–æ–∏—Å–∫ –Ω–∏–∫–∞...">
                <div class="action-btn" onclick="Engine.Network.addFriend()" style="background: var(--accent); color: white; border-radius: 12px;">+</div>
            </div>
        </div>
        <div id="contacts-list" class="node-list"></div>
        <nav class="mu-nav">
            <div class="mu-nav-btn active" onclick="Engine.Router.go('scr-hub')"><i>üì°</i><span>–°–í–Ø–ó–¨</span></div>
            <div class="mu-nav-btn" onclick="Engine.Router.go('scr-core')"><i>üõ°Ô∏è</i><span>–Ø–î–†–û</span></div>
        </nav>
    </section>

    <section id="scr-chat" class="mu-viewport">
        <header class="mu-header">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div class="action-btn" onclick="Engine.Router.go('scr-hub')">‚Üê</div>
                <div>
                    <div id="chat-peer-name" style="font-weight: 900; font-size: 17px;">User</div>
                    <div style="font-size: 10px; color: var(--accent);">SECURE NODE</div>
                </div>
            </div>
            <div class="action-btn" onclick="Engine.Call.init()" style="color: var(--accent);">üìû</div>
        </header>
        <div id="chat-messages" class="chat-flow"></div>
        
        <div id="sticker-panel" class="extra-panel">
            <div class="sticker-grid">
                <div class="stk-item" onclick="Engine.Chat.sendSticker('üî•')">üî•</div>
                <div class="stk-item" onclick="Engine.Chat.sendSticker('üíÄ')">üíÄ</div>
                <div class="stk-item" onclick="Engine.Chat.sendSticker('ü§°')">ü§°</div>
                <div class="stk-item" onclick="Engine.Chat.sendSticker('üëë')">üëë</div>
                <div class="stk-item" onclick="Engine.Chat.sendSticker('‚ö°')">‚ö°</div>
                <div class="stk-item" onclick="Engine.Chat.sendSticker('ü•∂')">ü•∂</div>
                <div class="stk-item" onclick="Engine.Chat.sendSticker('üëæ')">üëæ</div>
                <div class="stk-item" onclick="Engine.Chat.sendSticker('‚ù§Ô∏è')">‚ù§Ô∏è</div>
            </div>
        </div>

        <div class="input-panel">
            <div class="action-btn" onclick="Engine.UI.toggleStickers()">üé≠</div>
            <label class="action-btn">
                üìé
                <input type="file" id="file-input" accept="image/*,video/*" hidden onchange="Engine.Chat.handleFile(this)">
            </label>
            <div class="field-wrap">
                <input type="text" id="msg-input" class="field" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
            </div>
            <div id="mic-btn" class="action-btn" onclick="Engine.Chat.toggleVoice()">üéôÔ∏è</div>
            <div class="action-btn" onclick="Engine.Chat.sendText()" style="color: var(--accent);">üöÄ</div>
        </div>
    </section>

    <section id="scr-core" class="mu-viewport">
        <header class="mu-header"><div class="mu-logo">ULTRA <span>CORE</span></div></header>
        <div class="node-list">
            <div class="node-card" style="pointer-events: none;">
                <div class="node-ava" id="my-ava">?</div>
                <div>
                    <h3 id="my-nick">User</h3>
                    <p style="color: var(--accent); font-size: 10px; font-weight: 800;">ADMIN PRIVILEGES</p>
                </div>
            </div>
            <h4 style="margin: 20px 0 10px; font-size: 12px; color: var(--text-sec);">–ò–ù–¢–ï–†–§–ï–ô–°</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="node-card" onclick="Engine.UI.setTheme('dark')" style="justify-content: center; font-weight: 900;">DARK</div>
                <div class="node-card" onclick="Engine.UI.setTheme('white')" style="justify-content: center; font-weight: 900;">WHITE</div>
            </div>
            <button onclick="location.reload()" style="width: 100%; height: 60px; border-radius: 18px; border: 1px solid #ff3b30; background: none; color: #ff3b30; font-weight: 900; margin-top: 40px;">LOGOUT SYSTEM</button>
        </div>
        <nav class="mu-nav">
            <div class="mu-nav-btn" onclick="Engine.Router.go('scr-hub')"><i>üì°</i><span>–°–í–Ø–ó–¨</span></div>
            <div class="mu-nav-btn active" onclick="Engine.Router.go('scr-core')"><i>üõ°Ô∏è</i><span>–Ø–î–†–û</span></div>
        </nav>
    </section>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, get, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const FB_CONFIG = {
            apiKey: "AIzaSyDutfZZER58asyHr68zWlCx7B5k1adFhIk",
            authDomain: "morozov-ultra.firebaseapp.com",
            databaseURL: "https://morozov-ultra-default-rtdb.firebaseio.com",
            projectId: "morozov-ultra",
            appId: "1:255345933856:web:5b8d1b93696f36eb5d4645"
        };

        const app = initializeApp(FB_CONFIG);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // [ GLOBAL ENGINE OBJECT ]
        window.Engine = {
            user: null, peer: null, room: null, recorder: null, chunks: [],

            Router: {
                go: (id) => {
                    document.querySelectorAll('.mu-viewport').forEach(v => v.classList.remove('active'));
                    document.getElementById(id).classList.add('active');
                }
            },

            Auth: {
                process: async () => {
                    const e = document.getElementById('auth-email').value;
                    const p = document.getElementById('auth-pass').value;
                    const n = document.getElementById('auth-nick').value;
                    try {
                        await signInWithEmailAndPassword(auth, e, p);
                    } catch (err) {
                        if(n) {
                            const res = await createUserWithEmailAndPassword(auth, e, p);
                            const data = { id: n, uid: res.user.uid, email: e };
                            await set(ref(db, `mu_v25/users/${res.user.uid}`), data);
                            await set(ref(db, `mu_v25/map/${n}`), res.user.uid);
                        }
                    }
                }
            },

            Network: {
                addFriend: async () => {
                    const target = document.getElementById('find-node').value;
                    const snap = await get(ref(db, `mu_v25/map/${target}`));
                    if(snap.exists()) {
                        const uid = snap.val();
                        const pack = {};
                        pack[`mu_v25/friends/${Engine.user.uid}/${uid}`] = { id: target, uid: uid };
                        pack[`mu_v25/friends/${uid}/${Engine.user.uid}`] = { id: Engine.user.id, uid: Engine.user.uid };
                        await update(ref(db), pack);
                        document.getElementById('find-node').value = "";
                    }
                }
            },

            Chat: {
                sendText: () => {
                    const i = document.getElementById('msg-input');
                    if(!i.value) return;
                    Engine.Chat.pushToDB({ txt: i.value, type: 'text' });
                    i.value = "";
                },

                sendSticker: (s) => {
                    Engine.Chat.pushToDB({ txt: s, type: 'sticker' });
                    Engine.UI.toggleStickers();
                },

                // –ú–ï–•–ê–ù–ò–ö–ê –§–û–¢–û –ò –í–ò–î–ï–û (Base64 Injection)
                handleFile: (el) => {
                    const file = el.files[0];
                    if(!file) return;
                    const reader = new FileReader();
                    const type = file.type.startsWith('image') ? 'image' : 'video';
                    
                    reader.onload = (e) => {
                        Engine.Chat.pushToDB({ txt: e.target.result, type: type });
                    };
                    reader.readAsDataURL(file);
                },

                toggleVoice: async () => {
                    const btn = document.getElementById('mic-btn');
                    if(!Engine.recorder) {
                        const s = await navigator.mediaDevices.getUserMedia({ audio: true });
                        Engine.recorder = new MediaRecorder(s);
                        Engine.recorder.ondataavailable = e => Engine.chunks.push(e.data);
                        Engine.recorder.onstop = () => {
                            const blob = new Blob(Engine.chunks, { type: 'audio/ogg' });
                            const reader = new FileReader();
                            reader.onload = () => Engine.Chat.pushToDB({ txt: reader.result, type: 'audio' });
                            reader.readAsDataURL(blob);
                            Engine.chunks = [];
                        };
                        Engine.recorder.start();
                        btn.classList.add('rec');
                    } else {
                        Engine.recorder.stop();
                        Engine.recorder = null;
                        btn.classList.remove('rec');
                    }
                },

                pushToDB: (data) => {
                    if(!Engine.room) return;
                    push(ref(db, `mu_v25/msgs/${Engine.room}`), {
                        ...data,
                        sid: Engine.user.uid,
                        time: Date.now()
                    });
                }
            },

            Call: {
                init: () => {
                    set(ref(db, `mu_v25/calls/${Engine.peer.uid}`), { from: Engine.user.id, fromUid: Engine.user.uid });
                },
                end: () => {
                    remove(ref(db, `mu_v25/calls/${Engine.user.uid}`));
                    document.getElementById('call-screen').classList.remove('active');
                },
                answer: () => {
                    alert("–®–ò–§–†–û–í–ê–ù–ù–´–ô –ö–ê–ù–ê–õ –£–°–¢–ê–ù–û–í–õ–ï–ù");
                    Engine.Call.end();
                }
            },

            UI: {
                toggleStickers: () => {
                    const p = document.getElementById('sticker-panel');
                    p.style.display = p.style.display === 'block' ? 'none' : 'block';
                },
                setTheme: (t) => {
                    document.body.style.filter = t === 'white' ? 'invert(1) hue-rotate(180deg)' : 'none';
                }
            }
        };

        // [ CORE OBSERVER ]
        onAuthStateChanged(auth, u => {
            if(u) {
                onValue(ref(db, `mu_v25/users/${u.uid}`), snap => {
                    Engine.user = snap.val();
                    if(Engine.user) {
                        Engine.Router.go('scr-hub');
                        document.getElementById('my-nick').innerText = Engine.user.id;
                        document.getElementById('my-ava').innerText = Engine.user.id[0];

                        // –ó–≤–æ–Ω–∫–∏
                        onValue(ref(db, `mu_v25/calls/${u.uid}`), cSnap => {
                            if(cSnap.exists()) {
                                const c = cSnap.val();
                                document.getElementById('c-name').innerText = c.from;
                                document.getElementById('c-ava').innerText = c.from[0];
                                document.getElementById('call-screen').classList.add('active');
                            }
                        });

                        // –ö–æ–Ω—Ç–∞–∫—Ç—ã
                        onValue(ref(db, `mu_v25/friends/${u.uid}`), fSnap => {
                            const list = document.getElementById('contacts-list');
                            list.innerHTML = "";
                            fSnap.forEach(f => {
                                const d = f.val();
                                const el = document.createElement('div');
                                el.className = "node-card";
                                el.innerHTML = `<div class="node-ava">${d.id[0]}</div><div><b>${d.id}</b><br><small style="color:var(--accent)">ONLINE</small></div>`;
                                el.onclick = () => {
                                    Engine.peer = d;
                                    Engine.room = [Engine.user.uid, d.uid].sort().join("_");
                                    document.getElementById('chat-peer-name').innerText = d.id;
                                    Engine.Router.go('scr-chat');
                                    // –ü–æ—Ç–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
                                    onValue(ref(db, `mu_v25/msgs/${Engine.room}`), mSnap => {
                                        const box = document.getElementById('chat-messages');
                                        box.innerHTML = "";
                                        mSnap.forEach(m => {
                                            const data = m.val();
                                            const item = document.createElement('div');
                                            item.className = `msg ${data.sid === Engine.user.uid ? 'sent' : 'received'} ${data.type === 'sticker' ? 'msg-sticker' : ''}`;
                                            
                                            if(data.type === 'text') item.innerText = data.txt;
                                            else if(data.type === 'sticker') item.innerText = data.txt;
                                            else if(data.type === 'image') item.innerHTML = `<img src="${data.txt}" class="msg-img">`;
                                            else if(data.type === 'video') item.innerHTML = `<video src="${data.txt}" class="msg-video" controls></video>`;
                                            else if(data.type === 'audio') item.innerHTML = `<audio src="${data.txt}" controls style="width:180px;"></audio>`;
                                            
                                            box.appendChild(item);
                                        });
                                        box.scrollTop = box.scrollHeight;
                                    });
                                };
                                list.appendChild(el);
                            });
                        });
                    }
                });
            } else Engine.Router.go('scr-auth');
        });
    </script>
</body>
</html>
