<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ULTRA v16.1 | FULL INFRASTRUCTURE</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --u-bg: #010204;
            --u-surf: #0d1117;
            --u-border: #30363d;
            --u-accent: #2f81f7;
            --u-red: #f85149;
            --u-green: #3fb950;
        }

        body, html { 
            background: var(--u-bg); 
            color: #c9d1d9; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
        }

        /* –≠–∫—Ä–∞–Ω—ã */
        .u-screen { position: fixed; inset: 0; display: none; flex-direction: column; background: var(--u-bg); z-index: 10; }
        .u-screen.active { display: flex; z-index: 100; }

        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫–∏ */
        .u-input {
            background: #010409;
            border: 1px solid var(--u-border);
            padding: 22px;
            border-radius: 24px;
            color: white;
            width: 100%;
            font-size: 16px;
            margin-bottom: 15px;
            outline: none;
        }
        .u-input:focus { border-color: var(--u-accent); }

        .u-btn {
            padding: 20px;
            border-radius: 24px;
            font-weight: 800;
            color: white;
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            transition: transform 0.2s, background 0.3s;
        }
        .u-btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--u-accent); }
        .btn-secondary { background: transparent; border: 2px solid var(--u-border); color: #8b949e; }

        /* –ß–∞—Ç –∏ –≤–∏–¥–µ–æ */
        .bubble { max-width: 80%; padding: 15px 20px; border-radius: 25px; font-size: 15px; margin-bottom: 8px; }
        .bubble-me { align-self: flex-end; background: var(--u-accent); border-bottom-right-radius: 5px; }
        .bubble-he { align-self: flex-start; background: var(--u-surf); border: 1px solid var(--u-border); border-bottom-left-radius: 5px; }

        #video-grid { position: fixed; inset: 0; background: black; z-index: 1000; display: none; }
        #remote-stream { width: 100%; height: 100%; object-fit: cover; }
        #local-stream { 
            position: absolute; top: 40px; right: 20px; 
            width: 120px; height: 180px; border-radius: 20px; 
            border: 2px solid rgba(255,255,255,0.2); object-fit: cover;
        }
    </style>
</head>
<body>

    <div id="scr-gate" class="u-screen active justify-center items-center px-10">
        <div class="w-full max-w-sm text-center">
            <h1 class="text-6xl font-black italic mb-10 tracking-tighter text-white">ULTRA <span class="text-blue-500">TITAN</span></h1>
            
            <div class="bg-[var(--u-surf)] p-8 rounded-[40px] border border-[var(--u-border)] shadow-2xl">
                <input id="auth-email" type="email" placeholder="Email Address" class="u-input">
                <input id="auth-pass" type="password" placeholder="Password" class="u-input">
                <input id="auth-nick" type="text" placeholder="–ü—Ä–∏–¥—É–º–∞–π ID (–¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)" class="u-input">
                
                <div class="flex flex-col gap-3 mt-4">
                    <button onclick="handleAuth('login')" class="u-btn btn-primary w-full">–í–û–ô–¢–ò (Login)</button>
                    <button onclick="handleAuth('register')" class="u-btn btn-secondary w-full text-xs">–°–û–ó–î–ê–¢–¨ –ê–ö–ö–ê–£–ù–¢ (Register)</button>
                </div>
                
                <p id="auth-log" class="text-red-500 mt-6 text-[10px] font-black uppercase tracking-widest"></p>
            </div>
        </div>
    </div>

    <div id="scr-main" class="u-screen">
        <header class="p-8 border-b border-[var(--u-border)] flex justify-between items-center bg-[var(--u-surf)]">
            <div>
                <b class="text-2xl italic text-white">TITAN HUB</b>
                <div id="my-id-label" class="text-blue-500 text-[10px] font-bold uppercase mt-1">ID: ...</div>
            </div>
            <button onclick="addFriendProcess()" class="w-14 h-14 bg-blue-600 rounded-2xl flex items-center justify-center shadow-lg">
                <i class="fas fa-plus text-xl"></i>
            </button>
        </header>
        <div id="friends-container" class="flex-1 overflow-y-auto p-8 space-y-4"></div>
    </div>

    <div id="scr-chat" class="u-screen">
        <header class="p-6 border-b border-[var(--u-border)] flex items-center gap-5 bg-[var(--u-surf)]">
            <button onclick="nav('main')" class="text-2xl opacity-40"><i class="fas fa-arrow-left"></i></button>
            <div class="flex-1">
                <b id="chat-user-name" class="text-xl">Agent</b>
                <div id="online-status" class="text-[9px] uppercase font-bold text-gray-500">Connecting...</div>
            </div>
            <div class="flex gap-4">
                <button onclick="startCallSession(false)" class="w-12 h-12 bg-green-500/10 text-green-500 rounded-xl flex items-center justify-center"><i class="fas fa-phone"></i></button>
                <button onclick="startCallSession(true)" class="w-12 h-12 bg-blue-500/10 text-blue-500 rounded-xl flex items-center justify-center"><i class="fas fa-video"></i></button>
            </div>
        </header>

        <div id="chat-messages" class="flex-1 overflow-y-auto p-6 flex flex-col"></div>

        <div id="sticker-panel" class="hidden grid grid-cols-4 gap-4 p-6 bg-[var(--u-surf)] border-t border-[var(--u-border)]">
            <span onclick="sendEmoji('üî•')" class="text-3xl cursor-pointer text-center">üî•</span>
            <span onclick="sendEmoji('üíÄ')" class="text-3xl cursor-pointer text-center">üíÄ</span>
            <span onclick="sendEmoji('üëª')" class="text-3xl cursor-pointer text-center">üëª</span>
            <span onclick="sendEmoji('ü§°')" class="text-3xl cursor-pointer text-center">ü§°</span>
        </div>

        <div class="p-6 bg-[var(--u-surf)] flex gap-4 items-center">
            <button onclick="document.getElementById('sticker-panel').classList.toggle('hidden')" class="text-2xl opacity-40"><i class="far fa-face-smile"></i></button>
            <input id="chat-input" class="u-input !mb-0 flex-1" placeholder="Type a message...">
            <button onclick="sendMessage()" class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center shadow-xl"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="video-grid">
        <video id="remote-stream" autoplay playsinline></video>
        <video id="local-stream" autoplay muted playsinline></video>
        <div class="absolute bottom-12 left-0 w-full flex justify-center gap-8">
            <button onclick="location.reload()" class="w-20 h-20 bg-red-600 rounded-full text-white text-3xl shadow-2xl"><i class="fas fa-phone-slash"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, get, update, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDutfZZER58asyHr68zWlCx7B5k1adFhIk",
            authDomain: "morozov-ultra.firebaseapp.com",
            databaseURL: "https://morozov-ultra-default-rtdb.firebaseio.com",
            projectId: "morozov-ultra",
            appId: "1:255345933856:web:5b8d1b93696f36eb5d4645"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let userProfile = null;
        let chatPartner = null;
        let chatRoomId = null;
        let peerConn = null;
        let myStream = null;

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        window.nav = (id) => {
            document.querySelectorAll('.u-screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`scr-${id}`).classList.add('active');
        };

        // --- –õ–û–ì–ò–ö–ê –í–•–û–î–ê –ò –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò ---
        window.handleAuth = async (mode) => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const nick = document.getElementById('auth-nick').value.trim();
            const log = document.getElementById('auth-log');

            if(!email || !pass) { log.innerText = "Error: Email & Pass required"; return; }

            if (mode === 'login') {
                try {
                    await signInWithEmailAndPassword(auth, email, pass);
                } catch (e) { log.innerText = "LOGIN FAILED: CHECK CREDENTIALS"; }
            } else {
                if(!nick) { log.innerText = "Error: Nickname required for registration"; return; }
                try {
                    const res = await createUserWithEmailAndPassword(auth, email, pass);
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∏–∫
                    await set(ref(db, `v16/ids/${nick}`), res.user.uid);
                    await set(ref(db, `v16/users/${res.user.uid}`), { id: nick, uid: res.user.uid, email: email });
                } catch (e) { log.innerText = "REGISTRATION FAILED: " + e.message; }
            }
        };

        onAuthStateChanged(auth, u => {
            if(u) {
                onValue(ref(db, `v16/users/${u.uid}`), s => {
                    userProfile = s.val();
                    if(userProfile) {
                        document.getElementById('my-id-label').innerText = "YOUR ID: " + userProfile.id;
                        nav('main');
                        syncFriendList();
                        listenForCalls();
                        // –°—Ç–∞—Ç—É—Å
                        const st = ref(db, `v16/status/${u.uid}`);
                        set(st, "online");
                        onDisconnect(st).set("offline");
                    }
                });
            }
        });

        // --- –î–û–ë–ê–í–õ–ï–ù–ò–ï –í –î–† –ü–û ID ---
        window.addFriendProcess = async () => {
            const targetId = prompt("Enter Friend's ID:");
            if(!targetId) return;
            
            const snap = await get(ref(db, `v16/ids/${targetId}`));
            if(snap.exists()) {
                const targetUid = snap.val();
                await update(ref(db, `v16/social/${userProfile.uid}/${targetUid}`), { id: targetId, uid: targetUid });
                await update(ref(db, `v16/social/${targetUid}/${userProfile.uid}`), { id: userProfile.id, uid: userProfile.uid });
                alert("FRIEND ADDED!");
            } else {
                alert("ID NOT FOUND");
            }
        };

        function syncFriendList() {
            onValue(ref(db, `v16/social/${userProfile.uid}`), snap => {
                const container = document.getElementById('friends-container');
                container.innerHTML = "";
                snap.forEach(child => {
                    const d = child.val();
                    const el = document.createElement('div');
                    el.className = "p-6 bg-[var(--u-surf)] rounded-3xl border border-[var(--u-border)] flex justify-between items-center cursor-pointer active:scale-95 transition-all";
                    el.innerHTML = `<div><b class="text-xl">${d.id}</b><p class="text-[10px] opacity-40">TITAN NODE ACTIVE</p></div><i class="fas fa-chevron-right opacity-20"></i>`;
                    el.onclick = () => openChat(d);
                    container.appendChild(el);
                });
            });
        }

        // --- –ß–ê–¢ ---
        function openChat(p) {
            chatPartner = p;
            chatRoomId = [userProfile.uid, p.uid].sort().join("_");
            nav('chat');
            document.getElementById('chat-user-name').innerText = p.id;
            
            onValue(ref(db, `v16/status/${p.uid}`), s => {
                const isOnline = s.val() === "online";
                document.getElementById('online-status').innerText = isOnline ? "Online" : "Offline";
                document.getElementById('online-status').style.color = isOnline ? "#3fb950" : "";
            });

            onValue(ref(db, `v16/rooms/${chatRoomId}`), snap => {
                const feed = document.getElementById('chat-messages');
                feed.innerHTML = "";
                snap.forEach(m => {
                    const d = m.val();
                    const isMe = d.sid === userProfile.uid;
                    const div = document.createElement('div');
                    div.className = `bubble ${isMe ? 'bubble-me' : 'bubble-he'}`;
                    div.innerText = d.txt;
                    feed.appendChild(div);
                });
                feed.scrollTop = feed.scrollHeight;
            });
        }

        window.sendMessage = () => {
            const inp = document.getElementById('chat-input');
            const val = inp.value.trim();
            if(!val) return;
            push(ref(db, `v16/rooms/${chatRoomId}`), { sid: userProfile.uid, txt: val });
            inp.value = "";
        };

        window.sendEmoji = (emoji) => {
            push(ref(db, `v16/rooms/${chatRoomId}`), { sid: userProfile.uid, txt: emoji });
            document.getElementById('sticker-panel').classList.add('hidden');
        };

        // --- –í–ò–î–ï–û–°–í–Ø–ó–¨ (TITAN WEBRTC) ---
        window.startCallSession = async (withVideo) => {
            document.getElementById('video-grid').style.display = 'block';
            try {
                myStream = await navigator.mediaDevices.getUserMedia({ video: withVideo, audio: true });
                document.getElementById('local-stream').srcObject = myStream;

                peerConn = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
                myStream.getTracks().forEach(track => peerConn.addTrack(track, myStream));

                peerConn.ontrack = e => document.getElementById('remote-stream').srcObject = e.streams[0];
                peerConn.onicecandidate = e => e.candidate && push(ref(db, `v16/calls/${chatPartner.uid}/ice`), e.candidate.toJSON());

                const offer = await peerConn.createOffer();
                await peerConn.setLocalDescription(offer);
                
                await set(ref(db, `v16/calls/${chatPartner.uid}/signal`), {
                    offer: offer,
                    from: userProfile.uid,
                    fromId: userProfile.id,
                    video: withVideo
                });

                onValue(ref(db, `v16/calls/${chatPartner.uid}/answer`), async snap => {
                    if(snap.val()) await peerConn.setRemoteDescription(new RTCSessionDescription(snap.val()));
                });
            } catch (err) { alert("ERROR: Camera blocked!"); location.reload(); }
        };

        function listenForCalls() {
            onValue(ref(db, `v16/calls/${userProfile.uid}/signal`), async snap => {
                const data = snap.val();
                if(data && !peerConn) {
                    if(confirm("Call from " + data.fromId + "?")) {
                        chatPartner = { uid: data.from, id: data.fromId };
                        await startCallSession(data.video);
                        await peerConn.setRemoteDescription(new RTCSessionDescription(data.offer));
                        const answer = await peerConn.createAnswer();
                        await peerConn.setLocalDescription(answer);
                        set(ref(db, `v16/calls/${data.from}/answer`), answer);
                        onValue(ref(db, `v16/calls/${userProfile.uid}/ice`), s => s.forEach(c => peerConn.addIceCandidate(new RTCIceCandidate(c.val()))));
                    } else {
                        remove(ref(db, `v16/calls/${userProfile.uid}`));
                    }
                }
            });
        }
    </script>
</body>
</html>
