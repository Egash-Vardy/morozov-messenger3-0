<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Morozov Ultra Pro Max</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --tg-blue: #3390ec; --tg-gray: #707579; }
        
        /* –ë–∞–∑–∞ –∏ —Å–∫—Ä–æ–ª–ª */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { height: 100%; margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 10px; }

        /* –¢–ï–ú–´ */
        body.light-theme { --bg: #f0f2f5; --text: #000; --header: #517da2; --menu-bg: #ffffff; --chat-bg: #e5ddd5; --msg-mine: #effdde; --msg-their: #ffffff; }
        body.dark-theme { --bg: #0f1721; --text: #ffffff; --header: #1c2733; --menu-bg: #17212b; --chat-bg: #0e1621; --msg-mine: #2b5278; --msg-their: #182533; }

        body { background-color: var(--bg); color: var(--text); transition: background 0.2s; }

        /* –®–∞–ø–∫–∞ */
        .app-header { background-color: var(--header); height: 60px; display: flex; align-items: center; padding: 0 15px; color: white; position: relative; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é */
        .side-menu { position: fixed; top: 0; left: 0; bottom: 0; width: 280px; background: var(--menu-bg); z-index: 1000; transform: translateX(-100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 5px 0 15px rgba(0,0,0,0.3); }
        .side-menu.open { transform: translateX(0); }
        .menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none; }
        .menu-overlay.open { display: block; }

        /* –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ */
        .contact-item { display: flex; align-items: center; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid rgba(120,120,120,0.1); transition: 0.2s; }
        .contact-item:active { background: rgba(120,120,120,0.1); }
        .avatar { width: 50px; height: 50px; border-radius: 50%; background: var(--tg-blue); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 20px; flex-shrink: 0; }

        /* –û–∫–Ω–æ —á–∞—Ç–∞ */
        .chat-screen { position: fixed; inset: 0; background: var(--chat-bg); z-index: 500; display: flex; flex-direction: column; transform: translateX(100%); transition: 0.3s; }
        .chat-screen.open { transform: translateX(0); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; }

        /* –°–æ–æ–±—â–µ–Ω–∏—è (–ë–∞–±–±–ª—ã) */
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 15px; position: relative; font-size: 15px; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg-mine { align-self: flex-end; background-color: var(--msg-mine); border-bottom-right-radius: 4px; }
        .msg-their { align-self: flex-start; background-color: var(--msg-their); border-bottom-left-radius: 4px; }
        .msg-info { display: flex; align-items: center; justify-content: flex-end; gap: 4px; font-size: 10px; opacity: 0.6; margin-top: 4px; }
        .msg-sticker { background: transparent !important; box-shadow: none !important; font-size: 60px; padding: 0; }

        /* –í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .input-area { background: var(--menu-bg); padding: 10px 15px 25px 15px; display: flex; align-items: center; gap: 10px; }
        .input-field { flex: 1; background: var(--bg); border-radius: 20px; padding: 10px 15px; outline: none; border: 1px solid rgba(120,120,120,0.2); }

        /* –ü–∞–Ω–µ–ª–∏ */
        .sticker-panel { height: 200px; background: var(--menu-bg); display: grid; grid-template-columns: repeat(4, 1fr); overflow-y: auto; padding: 10px; border-top: 1px solid rgba(0,0,0,0.1); }
        .sticker-item { font-size: 40px; text-align: center; padding: 10px; cursor: pointer; }

        /* –ì–æ–ª–æ—Å–æ–≤—ã–µ */
        .voice-rec { color: #f44336; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } }
        
        /* –í–∏–¥–µ–æ –∑–≤–æ–Ω–æ–∫ */
        #call-ui { position: fixed; inset: 0; background: #000; z-index: 2000; display: none; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { position: absolute; top: 20px; right: 20px; width: 100px; height: 150px; border-radius: 10px; border: 2px solid white; object-fit: cover; }
    </style>
</head>
<body class="light-theme">

    <div id="auth-overlay" class="fixed inset-0 z-[5000] bg-[#2b5278] flex items-center justify-center p-6">
        <div class="bg-white p-8 rounded-3xl w-full max-w-sm shadow-2xl text-center text-black">
            <h1 class="text-3xl font-bold mb-2 text-[#2b5278]">Morozov Ultra</h1>
            <p class="text-gray-500 mb-6 text-sm">–í—Ö–æ–¥ –≤ –∑–∞—â–∏—â–µ–Ω–Ω—É—é —Å–µ—Ç—å</p>
            <input id="auth-name" type="text" placeholder="–í–∞—à–µ –ò–º—è" class="w-full p-4 mb-3 border rounded-xl outline-none focus:ring-2 ring-blue-400">
            <input id="auth-email" type="email" placeholder="Email" class="w-full p-4 mb-3 border rounded-xl outline-none focus:ring-2 ring-blue-400">
            <input id="auth-pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full p-4 mb-6 border rounded-xl outline-none focus:ring-2 ring-blue-400">
            <button onclick="handleAuth()" class="w-full bg-[#3390ec] text-white py-4 rounded-xl font-bold text-lg active:scale-95 transition">–í–û–ô–¢–ò</button>
        </div>
    </div>

    <div class="flex flex-col h-full">
        <header class="app-header">
            <button onclick="toggleMenu(true)" class="text-xl mr-5"><i class="fas fa-bars"></i></button>
            <span class="text-lg font-bold">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</span>
        </header>
        
        <div id="contacts-list" class="flex-1 overflow-y-auto bg-inherit">
            <div class="p-10 text-center opacity-50">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –º–µ–Ω—é, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–∑–µ–π</div>
        </div>
    </div>

    <div id="menu-overlay" class="menu-overlay" onclick="toggleMenu(false)"></div>
    <div id="side-menu" class="side-menu">
        <div class="p-6 bg-[#3390ec] text-white">
            <div id="user-avatar" class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center text-3xl font-bold mb-4">?</div>
            <input id="profile-name" type="text" class="bg-transparent border-none text-xl font-bold outline-none w-full" value="–ó–∞–≥—Ä—É–∑–∫–∞...">
            <div id="user-uid" class="text-xs opacity-70 mt-1 truncate">ID: ...</div>
        </div>
        <div class="p-4 flex flex-col gap-1">
            <button onclick="toggleTheme()" class="flex items-center gap-5 p-4 hover:bg-black/5 rounded-xl w-full text-left">
                <i class="fas fa-moon w-5"></i> –¢–µ–º–Ω–∞—è —Ç–µ–º–∞
            </button>
            <button onclick="openAddFriend()" class="flex items-center gap-5 p-4 hover:bg-black/5 rounded-xl w-full text-left">
                <i class="fas fa-user-plus w-5"></i> –î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞
            </button>
            <button onclick="saveProfile()" class="flex items-center gap-5 p-4 hover:bg-black/5 rounded-xl w-full text-left text-blue-500 font-bold">
                <i class="fas fa-save w-5"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
            </button>
            <hr class="my-2 opacity-10">
            <button onclick="logout()" class="flex items-center gap-5 p-4 hover:bg-red-50 rounded-xl w-full text-left text-red-500">
                <i class="fas fa-sign-out-alt w-5"></i> –í—ã–π—Ç–∏
            </button>
        </div>
    </div>

    <div id="chat-screen" class="chat-screen">
        <header class="app-header">
            <button onclick="closeChat()" class="text-xl mr-4"><i class="fas fa-arrow-left"></i></button>
            <div class="flex-1">
                <div id="chat-user-name" class="font-bold leading-none">–ò–º—è</div>
                <div id="typing-indicator" class="text-[10px] text-white/70 h-3"></div>
            </div>
            <button onclick="startCall('video')" class="p-2 ml-2"><i class="fas fa-video"></i></button>
        </header>
        
        <div id="chat-messages" class="chat-messages"></div>

        <div id="sticker-panel" class="sticker-panel hidden">
            <div class="sticker-item" onclick="sendSticker('üî•')">üî•</div>
            <div class="sticker-item" onclick="sendSticker('üòé')">üòé</div>
            <div class="sticker-item" onclick="sendSticker('‚ù§Ô∏è')">‚ù§Ô∏è</div>
            <div class="sticker-item" onclick="sendSticker('üêß')">üêß</div>
            <div class="sticker-item" onclick="sendSticker('üòÇ')">üòÇ</div>
            <div class="sticker-item" onclick="sendSticker('üëç')">üëç</div>
            <div class="sticker-item" onclick="sendSticker('üöÄ')">üöÄ</div>
            <div class="sticker-item" onclick="sendSticker('üçï')">üçï</div>
        </div>

        <div class="input-area">
            <button onclick="toggleStickers()" class="text-2xl text-gray-400"><i class="far fa-smile"></i></button>
            <input id="message-input" type="text" class="input-field" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." oninput="updateInputUI()">
            
            <button id="send-btn" onclick="sendMessage()" class="hidden w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center">
                <i class="fas fa-paper-plane"></i>
            </button>
            <button id="voice-btn" onclick="toggleVoiceRecord()" class="w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center">
                <i id="mic-icon" class="fas fa-microphone"></i>
            </button>
        </div>
    </div>

    <div id="call-ui">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted></video>
        <div class="absolute bottom-10 left-0 right-0 flex justify-center">
            <button onclick="endCall()" class="w-16 h-16 bg-red-600 rounded-full text-white text-3xl flex items-center justify-center shadow-xl">
                <i class="fas fa-phone-slash"></i>
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // –ö–û–ù–§–ò–ì
        const firebaseConfig = {
            apiKey: "AIzaSyDutfZZER58asyHr68zWlCx7B5k1adFhIk",
            authDomain: "morozov-ultra.firebaseapp.com",
            databaseURL: "https://morozov-ultra-default-rtdb.firebaseio.com",
            projectId: "morozov-ultra",
            storageBucket: "morozov-ultra.firebasestorage.app",
            messagingSenderId: "255345933856",
            appId: "1:255345933856:web:5b8d1b93696f36eb5d4645"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let user = null;
        let activeFriend = null;
        let recorder = null;
        let audioChunks = [];

        // 1. –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
        window.handleAuth = async () => {
            const n = document.getElementById('auth-name').value;
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-pass').value;
            if(!e || !p) return alert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è!");
            
            try {
                await signInWithEmailAndPassword(auth, e, p);
            } catch {
                const res = await createUserWithEmailAndPassword(auth, e, p);
                if(n) await updateProfile(res.user, { displayName: n });
            }
            location.reload();
        };

        onAuthStateChanged(auth, (u) => {
            if (u) {
                user = u;
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('profile-name').value = u.displayName || "–ë–µ–∑ –∏–º–µ–Ω–∏";
                document.getElementById('user-uid').innerText = "ID: " + u.uid;
                document.getElementById('user-avatar').innerText = (u.displayName || "U")[0].toUpperCase();
                loadFriends();
                initThemes();
            }
        });

        // 2. –¢–ï–ú–´ –ò –ò–ù–¢–ï–†–§–ï–ô–°
        function initThemes() {
            if(localStorage.getItem('theme') === 'dark') document.body.className = 'dark-theme';
        }
        window.toggleTheme = () => {
            const isDark = document.body.classList.toggle('dark-theme');
            document.body.classList.toggle('light-theme', !isDark);
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        };
        window.toggleMenu = (show) => {
            document.getElementById('side-menu').classList.toggle('open', show);
            document.getElementById('menu-overlay').classList.toggle('open', show);
        };

        // 3. –ü–†–û–§–ò–õ–¨
        window.saveProfile = async () => {
            const newName = document.getElementById('profile-name').value;
            await updateProfile(auth.currentUser, { displayName: newName });
            alert("–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!");
            location.reload();
        };
        window.logout = () => signOut(auth).then(() => location.reload());

        // 4. –î–†–£–ó–¨–Ø
        window.openAddFriend = () => {
            const id = prompt("–í–≤–µ–¥–∏—Ç–µ UID –¥—Ä—É–≥–∞:");
            const name = prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥—Ä—É–≥–∞:");
            if(id && name) {
                let friends = JSON.parse(localStorage.getItem('f_list') || "[]");
                friends.push({ id, name });
                localStorage.setItem('f_list', JSON.stringify(friends));
                loadFriends();
            }
        };

        function loadFriends() {
            const list = document.getElementById('contacts-list');
            list.innerHTML = "";
            const friends = JSON.parse(localStorage.getItem('f_list') || "[]");
            friends.forEach(f => {
                const el = document.createElement('div');
                el.className = "contact-item";
                el.innerHTML = `
                    <div class="avatar">${f.name[0]}</div>
                    <div class="ml-4 font-bold text-lg">${f.name}</div>
                `;
                el.onclick = () => openChat(f);
                list.appendChild(el);
            });
        }

        // 5. –ß–ê–¢
        window.openChat = (friend) => {
            activeFriend = friend;
            const screen = document.getElementById('chat-screen');
            screen.classList.add('open');
            document.getElementById('chat-user-name').innerText = friend.name;
            const chatID = [user.uid, friend.id].sort().join("_");
            
            onValue(ref(db, 'chats/' + chatID), (snap) => {
                const container = document.getElementById('chat-messages');
                container.innerHTML = "";
                snap.forEach(child => {
                    const m = child.val();
                    const d = document.createElement('div');
                    const isMine = m.sender === user.uid;
                    const time = new Date(m.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    
                    d.className = `msg ${isMine ? 'msg-mine' : 'msg-their'} ${m.type === 'sticker' ? 'msg-sticker' : ''}`;
                    
                    if(m.type === 'voice') {
                        d.innerHTML = `<audio controls src="${m.text}" class="w-48"></audio>`;
                    } else {
                        d.innerText = m.text;
                    }

                    d.innerHTML += `
                        <div class="msg-info">
                            <span>${time}</span>
                            ${isMine ? `<i class="fas ${m.read ? 'fa-check-double text-blue-400' : 'fa-check'}"></i>` : ''}
                        </div>
                    `;
                    
                    if(!isMine && !m.read) set(ref(db, `chats/${chatID}/${child.key}/read`), true);
                    container.appendChild(d);
                });
                container.scrollTop = container.scrollHeight;
            });
        };

        window.closeChat = () => document.getElementById('chat-screen').classList.remove('open');

        window.updateInputUI = () => {
            const val = document.getElementById('message-input').value;
            document.getElementById('send-btn').classList.toggle('hidden', val.length === 0);
            document.getElementById('voice-btn').classList.toggle('hidden', val.length > 0);
        };

        window.sendMessage = () => {
            const input = document.getElementById('message-input');
            if(!input.value.trim()) return;
            const chatID = [user.uid, activeFriend.id].sort().join("_");
            push(ref(db, 'chats/' + chatID), {
                sender: user.uid,
                text: input.value,
                time: Date.now(),
                read: false,
                type: 'text'
            });
            input.value = "";
            updateInputUI();
        };

        // 6. –°–¢–ò–ö–ï–†–´ –ò –ì–û–õ–û–°–û–í–´–ï
        window.toggleStickers = () => document.getElementById('sticker-panel').classList.toggle('hidden');
        window.sendSticker = (emoji) => {
            const chatID = [user.uid, activeFriend.id].sort().join("_");
            push(ref(db, 'chats/' + chatID), { sender: user.uid, text: emoji, time: Date.now(), read: false, type: 'sticker' });
            toggleStickers();
        };

        window.toggleVoiceRecord = async () => {
            if(!recorder) {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                recorder = new MediaRecorder(stream);
                audioChunks = [];
                recorder.ondataavailable = e => audioChunks.push(e.data);
                recorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.readAsDataURL(blob);
                    reader.onloadend = () => {
                        const chatID = [user.uid, activeFriend.id].sort().join("_");
                        push(ref(db, 'chats/' + chatID), { sender: user.uid, text: reader.result, time: Date.now(), read: false, type: 'voice' });
                    };
                };
                recorder.start();
                document.getElementById('mic-icon').className = "fas fa-stop voice-rec";
            } else {
                recorder.stop();
                recorder = null;
                document.getElementById('mic-icon').className = "fas fa-microphone";
            }
        };

        // 7. –ó–í–û–ù–ö–ò (WebRTC —É–ø—Ä–æ—â–µ–Ω–Ω–æ)
        window.startCall = () => {
            document.getElementById('call-ui').style.display = 'block';
            navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(s => {
                document.getElementById('local-video').srcObject = s;
            });
        };
        window.endCall = () => {
            document.getElementById('call-ui').style.display = 'none';
            location.reload();
        };

    </script>
</body>
</html>
