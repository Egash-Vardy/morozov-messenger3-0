<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ULTRA TITAN v30.0 | ENTERPRISE EDITION</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* ГЛОБАЛЬНЫЕ КОНСТАНТЫ ДИЗАЙНА */
        :root {
            --titan-background-black: #010204;
            --titan-surface-gray: #0d1117;
            --titan-border-gray: #30363d;
            --titan-accent-blue: #2f81f7;
            --titan-accent-green: #3fb950;
            --titan-accent-red: #f85149;
            --titan-text-main: #c9d1d9;
            --titan-text-dim: #8b949e;
            --titan-shadow-heavy: 0 10px 50px rgba(0,0,0,0.8);
        }

        /* БАЗОВЫЕ НАСТРОЙКИ СТРАНИЦЫ */
        * {
            box-sizing: border-box;
            outline: none;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--titan-background-black);
            color: var(--titan-text-main);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            user-select: none;
        }

        /* АРХИТЕКТУРА ЭКРАНОВ */
        .titan-screen-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            flex-direction: column;
            background: var(--titan-background-black);
            z-index: 100;
        }

        .titan-screen-container.active-screen {
            display: flex;
            animation: screenFadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes screenFadeIn {
            from { opacity: 0; transform: scale(1.05); }
            to { opacity: 1; transform: scale(1); }
        }

        /* СТИЛИЗАЦИЯ ИНПУТОВ */
        .titan-input-field {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid var(--titan-border-gray);
            padding: 22px;
            border-radius: 20px;
            color: #ffffff;
            font-size: 16px;
            font-weight: 500;
            width: 100%;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .titan-input-field:focus {
            border-color: var(--titan-accent-blue);
            background: var(--titan-surface-gray);
            box-shadow: 0 0 20px rgba(47, 129, 247, 0.2);
        }

        /* СТИЛИЗАЦИЯ КНОПОК */
        .titan-action-button {
            background: var(--titan-accent-blue);
            color: #ffffff;
            padding: 22px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            border: none;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .titan-action-button:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }

        .titan-action-button:active {
            transform: translateY(0) scale(0.97);
        }

        /* КОМПОНЕНТЫ ЧАТА */
        .chat-scroll-area {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: radial-gradient(circle at top, #0d1117 0%, #010204 100%);
        }

        .message-row {
            display: flex;
            width: 100%;
            margin-bottom: 5px;
        }

        .message-row.row-outgoing { justify-content: flex-end; }
        .message-row.row-incoming { justify-content: flex-start; }

        .message-bubble {
            max-width: 75%;
            padding: 16px 22px;
            border-radius: 25px;
            font-size: 15px;
            line-height: 1.4;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .bubble-outgoing {
            background: var(--titan-accent-blue);
            color: #ffffff;
            border-bottom-right-radius: 5px;
        }

        .bubble-incoming {
            background: var(--titan-surface-gray);
            border: 1px solid var(--titan-border-gray);
            color: var(--titan-text-main);
            border-bottom-left-radius: 5px;
        }

        /* ИНТЕРФЕЙС ЗВОНКА */
        .call-fullscreen-module {
            position: fixed;
            inset: 0;
            background: #000000;
            z-index: 5000;
            display: none;
        }

        .call-fullscreen-module.call-active {
            display: flex;
        }

        #remote-video-canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #local-video-canvas {
            position: absolute;
            top: 50px;
            right: 25px;
            width: 120px;
            height: 180px;
            border-radius: 20px;
            border: 2px solid rgba(255,255,255,0.4);
            object-fit: cover;
            z-index: 5001;
            background: #111111;
        }

        .call-actions-overlay {
            position: absolute;
            bottom: 60px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 30px;
            z-index: 5002;
        }

        .round-call-btn {
            width: 75px;
            height: 75px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-end-call {
            background: var(--titan-accent-red) !important;
            border: none;
        }

        /* НАСТРОЙКИ (SETTINGS UI) */
        .settings-container {
            flex: 1;
            overflow-y: auto;
            background: var(--titan-background-black);
        }

        .settings-block {
            padding: 25px;
            border-bottom: 1px solid var(--titan-border-gray);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            items-center;
            padding: 10px 0;
        }

        .settings-label {
            font-size: 16px;
            font-weight: 600;
        }

        .settings-description {
            font-size: 12px;
            color: var(--titan-text-dim);
        }

        /* ПАНЕЛЬ ВКЛАДОК */
        .bottom-navigation-bar {
            height: 85px;
            background: var(--titan-surface-gray);
            border-top: 1px solid var(--titan-border-gray);
            display: flex;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-tab-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--titan-text-dim);
            transition: 0.3s;
        }

        .nav-tab-item.tab-active {
            color: var(--titan-accent-blue);
        }

        .nav-tab-label {
            font-size: 10px;
            font-weight: 900;
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>

    <section id="titan-screen-auth" class="titan-screen-container active-screen justify-center items-center px-10">
        <div class="w-full max-w-md">
            <header class="text-center mb-12">
                <h1 class="text-7xl font-black italic tracking-tighter text-white">TITAN</h1>
                <p class="text-[10px] font-bold uppercase tracking-[0.5em] text-blue-500 mt-2">Monolith Enterprise v30.0</p>
            </header>

            <div class="bg-[var(--titan-surface-gray)] p-10 rounded-[40px] border border-[var(--titan-border-gray)] shadow-2xl">
                <div class="auth-fields-wrapper">
                    <input type="email" id="input-auth-email" class="titan-input-field" placeholder="Node Address (Email)" value="egorkamorozoff2014@gmail.com">
                    <input type="password" id="input-auth-password" class="titan-input-field" placeholder="Security Token (Password)">
                    <input type="text" id="input-auth-nickname" class="titan-input-field" placeholder="Global Identity ID (New Users)">
                </div>

                <button id="button-auth-submit" onclick="TitanEngine.Authentication.processEntry()" class="titan-action-button mt-6">
                    Initialize Core
                </button>

                <div id="auth-status-feedback" class="text-center mt-6 text-[10px] font-black uppercase tracking-widest text-gray-600">
                    Awaiting Handshake
                </div>
            </div>
        </div>
    </section>

    <section id="titan-screen-hub" class="titan-screen-container">
        <header class="p-8 border-b border-[var(--titan-border-gray)] flex justify-between items-center bg-[var(--titan-surface-gray)]/80 backdrop-blur-md">
            <div>
                <h2 class="text-2xl font-black italic uppercase tracking-tighter">Mesh Hub</h2>
                <div id="label-user-identity" class="text-blue-500 text-[10px] font-mono mt-1 uppercase font-bold tracking-widest">Node: Syncing...</div>
            </div>
            <button onclick="TitanEngine.SocialManager.initiateAddContact()" class="w-14 h-14 bg-blue-600 rounded-2xl flex items-center justify-center shadow-xl active:scale-90 transition">
                <i class="fas fa-plus text-white text-xl"></i>
            </button>
        </header>

        <div id="hub-contacts-list" class="flex-1 overflow-y-auto p-6 space-y-4">
            </div>

        <nav class="bottom-navigation-bar">
            <div class="nav-tab-item tab-active" onclick="TitanEngine.NavigationController.navigateTo('hub')">
                <i class="fas fa-comment-alt text-xl"></i>
                <span class="nav-tab-label">Messages</span>
            </div>
            <div class="nav-tab-item" onclick="TitanEngine.NavigationController.navigateTo('settings')">
                <i class="fas fa-cog text-xl"></i>
                <span class="nav-tab-label">Settings</span>
            </div>
        </nav>
    </section>

    <section id="titan-screen-chat" class="titan-screen-container">
        <header class="p-6 border-b border-[var(--titan-border-gray)] flex items-center gap-6 bg-[var(--titan-surface-gray)]">
            <button onclick="TitanEngine.NavigationController.navigateTo('hub')" class="text-2xl opacity-40 hover:opacity-100 transition">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="flex-1">
                <h3 id="label-chat-partner-name" class="text-xl font-bold tracking-tight">Agent</h3>
                <div id="label-chat-partner-status" class="text-[9px] font-black uppercase text-green-500 tracking-widest">Encrypted</div>
            </div>
            <div class="flex gap-4">
                <button onclick="TitanEngine.MediaController.startVoiceCall(false)" class="w-12 h-12 bg-white/5 rounded-xl flex items-center justify-center text-white/50">
                    <i class="fas fa-phone-alt"></i>
                </button>
                <button onclick="TitanEngine.MediaController.startVoiceCall(true)" class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                    <i class="fas fa-video"></i>
                </button>
            </div>
        </header>

        <div id="chat-messages-container" class="chat-scroll-area">
            </div>

        <footer class="p-6 bg-[var(--titan-surface-gray)] border-t border-[var(--titan-border-gray)] pb-10">
            <div class="flex gap-4 items-center">
                <button onclick="document.getElementById('input-file-attachment').click()" class="text-2xl opacity-30 hover:opacity-100 transition">
                    <i class="fas fa-paperclip"></i>
                </button>
                <input type="file" id="input-file-attachment" class="hidden" onchange="TitanEngine.MediaController.processFileUpload(this)">
                
                <input type="text" id="input-chat-message" class="titan-input-field !mb-0 !p-5 flex-1" placeholder="Type encrypted signal...">
                
                <button onclick="TitanEngine.ChatManager.sendMessage()" class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center shadow-2xl">
                    <i class="fas fa-paper-plane text-xl"></i>
                </button>
            </div>
        </footer>
    </section>

    <section id="titan-screen-settings" class="titan-screen-container">
        <header class="p-10 border-b border-[var(--titan-border-gray)]">
            <h2 class="text-3xl font-black italic uppercase tracking-tighter">Settings</h2>
        </header>

        <div class="settings-container">
            <div class="settings-block items-center py-12">
                <div id="settings-avatar-placeholder" class="w-24 h-24 bg-blue-600 rounded-[35px] flex items-center justify-center text-4xl font-black mb-4 shadow-2xl">?</div>
                <h3 id="settings-display-nickname" class="text-2xl font-bold">User Identity</h3>
                <p id="settings-display-email" class="text-gray-500 font-mono text-sm">email@titan.core</p>
            </div>

            <div class="settings-block">
                <div class="settings-row">
                    <div>
                        <div class="settings-label">Global Identity (Nickname)</div>
                        <div class="settings-description">Смените ваше имя в глобальной сети Titan.</div>
                    </div>
                    <button onclick="TitanEngine.AccountSettings.updateNickname()" class="text-blue-500 font-bold uppercase text-xs tracking-widest">Modify</button>
                </div>
            </div>

            <div class="settings-block">
                <div class="settings-row">
                    <div>
                        <div class="settings-label">Stealth Mode (Dark Theme)</div>
                        <div class="settings-description">Максимальное затемнение интерфейса.</div>
                    </div>
                    <div class="relative inline-block w-12 h-6">
                        <input type="checkbox" class="sr-only peer" onchange="TitanEngine.AccountSettings.toggleStealthMode(this)">
                        <div class="w-full h-full bg-gray-700 rounded-full peer-checked:bg-blue-600 transition"></div>
                    </div>
                </div>
            </div>

            <div class="settings-block">
                <button onclick="location.reload()" class="titan-action-button !bg-red-600/10 !text-red-500 !border !border-red-500/30">
                    Terminate Session
                </button>
            </div>
        </div>

        <nav class="bottom-navigation-bar">
            <div class="nav-tab-item" onclick="TitanEngine.NavigationController.navigateTo('hub')">
                <i class="fas fa-comment-alt text-xl"></i>
                <span class="nav-tab-label">Messages</span>
            </div>
            <div class="nav-tab-item tab-active" onclick="TitanEngine.NavigationController.navigateTo('settings')">
                <i class="fas fa-cog text-xl"></i>
                <span class="nav-tab-label">Settings</span>
            </div>
        </nav>
    </section>

    <div id="video-call-overlay" class="call-fullscreen-module">
        <video id="remote-video-canvas" autoplay playsinline></video>
        <video id="local-video-canvas" autoplay muted playsinline></video>
        
        <div class="call-actions-overlay">
            <button onclick="TitanEngine.MediaController.toggleMicState()" id="btn-call-mic" class="round-call-btn">
                <i class="fas fa-microphone"></i>
            </button>
            <button onclick="TitanEngine.MediaController.switchCameraSource()" class="round-call-btn">
                <i class="fas fa-camera-rotate"></i>
            </button>
            <button onclick="location.reload()" class="round-call-btn btn-end-call">
                <i class="fas fa-phone-slash"></i>
            </button>
        </div>
    </div>

    <script type="module">
        // Импорт официальных SDK Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, get, update, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // КОНФИГУРАЦИЯ СЕРВЕРНОЙ ЧАСТИ
        const FIREBASE_CONFIG_PARAMS = {
            apiKey: "AIzaSyDutfZZER58asyHr68zWlCx7B5k1adFhIk",
            authDomain: "morozov-ultra.firebaseapp.com",
            databaseURL: "https://morozov-ultra-default-rtdb.firebaseio.com",
            projectId: "morozov-ultra",
            storageBucket: "morozov-ultra.appspot.com",
            appId: "1:255345933856:web:5b8d1b93696f36eb5d4645"
        };

        // ИНИЦИАЛИЗАЦИЯ ЯДРА
        const TITAN_APP = initializeApp(FIREBASE_CONFIG_PARAMS);
        const TITAN_DB = getDatabase(TITAN_APP);
        const TITAN_AUTH = getAuth(TITAN_APP);
        const TITAN_STORAGE = getStorage(TITAN_APP);

        // ГЛОБАЛЬНЫЙ ОБЪЕКТ УПРАВЛЕНИЯ
        window.TitanEngine = {
            // Менеджер Состояний (Internal State)
            CoreState: {
                Identity: null,
                ActiveChatPartner: null,
                CurrentSyncRoom: null,
                WebRTC_Peer: null,
                LocalMediaStream: null,
                CameraFacingMode: 'user',
                MicrophoneEnabled: true
            },

            // Контроллер Навигации
            NavigationController: {
                navigateTo: (screenName) => {
                    const allScreens = document.querySelectorAll('.titan-screen-container');
                    allScreens.forEach(screen => screen.classList.remove('active-screen'));
                    
                    const targetScreen = document.getElementById(`titan-screen-${screenName}`);
                    if (targetScreen) {
                        targetScreen.classList.add('active-screen');
                    }
                }
            },

            // Система Авторизации
            Authentication: {
                processEntry: async () => {
                    const emailField = document.getElementById('input-auth-email').value;
                    const passwordField = document.getElementById('input-auth-password').value;
                    const nicknameField = document.getElementById('input-auth-nickname').value.trim();
                    const statusLabel = document.getElementById('auth-status-feedback');

                    if (!emailField || !passwordField) {
                        statusLabel.innerText = "Error: Input required";
                        return;
                    }

                    statusLabel.innerText = "Authorizing Node...";
                    statusLabel.style.color = "#2f81f7";

                    try {
                        // Попытка входа
                        await signInWithEmailAndPassword(TITAN_AUTH, emailField, passwordField);
                    } catch (error) {
                        // Попытка регистрации
                        if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                            if (!nicknameField) {
                                statusLabel.innerText = "Error: Nickname needed for registration";
                                return;
                            }

                            statusLabel.innerText = "Creating Global Identity...";
                            try {
                                const regResponse = await createUserWithEmailAndPassword(TITAN_AUTH, emailField, passwordField);
                                const userUid = regResponse.user.uid;

                                const profileData = {
                                    id: nicknameField,
                                    uid: userUid,
                                    email: emailField,
                                    status: "active",
                                    joined: Date.now()
                                };

                                await set(ref(TITAN_DB, `v30/users/${userUid}`), profileData);
                                await set(ref(TITAN_DB, `v30/global_map/${nicknameField}`), userUid);
                                
                                statusLabel.innerText = "Identity Registered!";
                            } catch (regErr) {
                                statusLabel.innerText = "Registry Failed: " + regErr.message;
                            }
                        } else {
                            statusLabel.innerText = "Security Alert: " + error.message;
                        }
                    }
                }
            },

            // Социальный Менеджер (Друзья/Контакты)
            SocialManager: {
                initiateAddContact: async () => {
                    const targetNick = prompt("Enter Target Global ID:");
                    if (!targetNick) return;

                    const lookupSnapshot = await get(ref(TITAN_DB, `v30/global_map/${targetNick}`));
                    if (lookupSnapshot.exists()) {
                        const targetUid = lookupSnapshot.val();
                        const myUid = TitanEngine.CoreState.Identity.uid;

                        // Взаимное добавление
                        const updates = {};
                        updates[`v30/social/${myUid}/${targetUid}`] = { id: targetNick, uid: targetUid };
                        updates[`v30/social/${targetUid}/${myUid}`] = { id: TitanEngine.CoreState.Identity.id, uid: myUid };
                        
                        await update(ref(TITAN_DB), updates);
                        alert("Node Linked Successfully!");
                    } else {
                        alert("Signal Error: Target node not found.");
                    }
                },

                startContactListener: () => {
                    const contactRef = ref(TITAN_DB, `v30/social/${TitanEngine.CoreState.Identity.uid}`);
                    onValue(contactRef, (snapshot) => {
                        const container = document.getElementById('hub-contacts-list');
                        container.innerHTML = "";
                        
                        snapshot.forEach((child) => {
                            const data = child.val();
                            const card = document.createElement('div');
                            card.className = "p-6 bg-[var(--titan-surface-gray)] rounded-[30px] border border-[var(--titan-border-gray)] flex justify-between items-center active:scale-95 transition shadow-lg cursor-pointer";
                            card.innerHTML = `
                                <div class="flex items-center gap-5">
                                    <div class="w-14 h-14 bg-blue-600/10 rounded-2xl flex items-center justify-center text-blue-500 font-black text-xl">
                                        ${data.id[0].toUpperCase()}
                                    </div>
                                    <div>
                                        <b class="text-white text-lg tracking-tight">${data.id}</b>
                                        <p class="text-[9px] text-gray-500 font-bold uppercase tracking-widest mt-1 italic">Authorized Peer</p>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right opacity-20"></i>
                            `;
                            card.onclick = () => TitanEngine.ChatManager.openChatSession(data);
                            container.appendChild(card);
                        });
                    });
                }
            },

            // Менеджер Сообщений
            ChatManager: {
                openChatSession: (partner) => {
                    TitanEngine.CoreState.ActiveChatPartner = partner;
                    TitanEngine.CoreState.CurrentSyncRoom = [TitanEngine.CoreState.Identity.uid, partner.uid].sort().join("_");
                    
                    TitanEngine.NavigationController.navigateTo('chat');
                    document.getElementById('label-chat-partner-name').innerText = partner.id;
                    
                    TitanEngine.ChatManager.listenForIncomingPackets();
                },

                listenForIncomingPackets: () => {
                    const roomRef = ref(TITAN_DB, `v30/rooms/${TitanEngine.CoreState.CurrentSyncRoom}`);
                    onValue(roomRef, (snapshot) => {
                        const feed = document.getElementById('chat-messages-container');
                        feed.innerHTML = "";
                        
                        snapshot.forEach((packetChild) => {
                            const packet = packetChild.val();
                            const isOutgoing = packet.senderId === TitanEngine.CoreState.Identity.uid;
                            
                            let htmlContent = "";
                            if (packet.type === 'text') {
                                htmlContent = packet.payload;
                            } else if (packet.type === 'media') {
                                if (packet.mime.includes('image')) {
                                    htmlContent = `<img src="${packet.url}" class="media-attachment" onclick="window.open('${packet.url}')">`;
                                } else {
                                    htmlContent = `<video src="${packet.url}" controls class="media-attachment"></video>`;
                                }
                            }
                            
                            feed.innerHTML += `
                                <div class="message-row ${isOutgoing ? 'row-outgoing' : 'row-incoming'}">
                                    <div class="message-bubble ${isOutgoing ? 'bubble-outgoing' : 'bubble-incoming'}">
                                        ${htmlContent}
                                    </div>
                                </div>
                            `;
                        });
                        feed.scrollTop = feed.scrollHeight;
                    });
                },

                sendMessage: () => {
                    const inputEl = document.getElementById('input-chat-message');
                    const textContent = inputEl.value.trim();
                    
                    if (!textContent) return;
                    
                    const packetRef = push(ref(TITAN_DB, `v30/rooms/${TitanEngine.CoreState.CurrentSyncRoom}`));
                    set(packetRef, {
                        senderId: TitanEngine.CoreState.Identity.uid,
                        payload: textContent,
                        type: 'text',
                        time: Date.now()
                    });
                    
                    inputEl.value = "";
                }
            },

            // Медиа Контроллер (Файлы и Звонки)
            MediaController: {
                processFileUpload: async (fileInput) => {
                    const file = fileInput.files[0];
                    if (!file) return;

                    const storageID = `v30_media_${Date.now()}_${file.name}`;
                    const fileRef = storageRef(TITAN_STORAGE, `v30/vault/${storageID}`);
                    
                    try {
                        console.log("Transmission started...");
                        await uploadBytes(fileRef, file);
                        const downloadUrl = await getDownloadURL(fileRef);
                        
                        const packetRef = push(ref(TITAN_DB, `v30/rooms/${TitanEngine.CoreState.CurrentSyncRoom}`));
                        set(packetRef, {
                            senderId: TitanEngine.CoreState.Identity.uid,
                            url: downloadUrl,
                            mime: file.type,
                            type: 'media',
                            time: Date.now()
                        });
                    } catch (err) {
                        alert("Transmission Failed: " + err.message);
                    }
                },

                startVoiceCall: async (useVideo) => {
                    document.getElementById('video-call-overlay').classList.add('call-active');
                    
                    try {
                        // Доступ к оборудованию
                        TitanEngine.CoreState.LocalMediaStream = await navigator.mediaDevices.getUserMedia({
                            video: useVideo ? { facingMode: TitanEngine.CoreState.CameraFacingMode } : false,
                            audio: true
                        });
                        
                        document.getElementById('local-video-canvas').srcObject = TitanEngine.CoreState.LocalMediaStream;
                        
                        // Инициализация WebRTC Peer
                        TitanEngine.CoreState.WebRTC_Peer = new RTCPeerConnection({
                            iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
                        });

                        // Инъекция треков
                        TitanEngine.CoreState.LocalMediaStream.getTracks().forEach(track => {
                            TitanEngine.CoreState.WebRTC_Peer.addTrack(track, TitanEngine.CoreState.LocalMediaStream);
                        });

                        // Обработка удаленного сигнала
                        TitanEngine.CoreState.WebRTC_Peer.ontrack = (event) => {
                            document.getElementById('remote-video-canvas').srcObject = event.streams[0];
                        };

                        // Передача ICE кандидатов
                        TitanEngine.CoreState.WebRTC_Peer.onicecandidate = (event) => {
                            if (event.candidate) {
                                const iceRef = push(ref(TITAN_DB, `v30/calls/${TitanEngine.CoreState.ActiveChatPartner.uid}/ice_pool`));
                                set(iceRef, event.candidate.toJSON());
                            }
                        };

                        // Создание оффера
                        const sessionOffer = await TitanEngine.CoreState.WebRTC_Peer.createOffer();
                        await TitanEngine.CoreState.WebRTC_Peer.setLocalDescription(sessionOffer);
                        
                        // Отправка сигнала в сеть
                        await set(ref(TITAN_DB, `v30/calls/${TitanEngine.CoreState.ActiveChatPartner.uid}/signal`), {
                            offer: sessionOffer,
                            callerId: TitanEngine.CoreState.Identity.uid,
                            callerName: TitanEngine.CoreState.Identity.id,
                            video: useVideo,
                            ts: Date.now()
                        });

                        // Прослушивание ответа
                        const answerRef = ref(TITAN_DB, `v30/calls/${TitanEngine.CoreState.Identity.uid}/answer`);
                        onValue(answerRef, async (snap) => {
                            const ans = snap.val();
                            if (ans && !TitanEngine.CoreState.WebRTC_Peer.currentRemoteDescription) {
                                await TitanEngine.CoreState.WebRTC_Peer.setRemoteDescription(new RTCSessionDescription(ans));
                            }
                        });

                    } catch (err) {
                        alert("Hardware Access Denied.");
                        location.reload();
                    }
                },

                toggleMicState: () => {
                    const currentState = TitanEngine.CoreState.MicrophoneEnabled;
                    TitanEngine.CoreState.LocalMediaStream.getAudioTracks()[0].enabled = !currentState;
                    TitanEngine.CoreState.MicrophoneEnabled = !currentState;
                    
                    document.getElementById('btn-call-mic').style.color = !currentState ? 'white' : '#f85149';
                },

                switchCameraSource: async () => {
                    const newMode = TitanEngine.CoreState.CameraFacingMode === 'user' ? 'environment' : 'user';
                    TitanEngine.CoreState.CameraFacingMode = newMode;
                    
                    if (TitanEngine.CoreState.LocalMediaStream) {
                        TitanEngine.CoreState.LocalMediaStream.getTracks().forEach(t => t.stop());
                        
                        const newStream = await navigator.mediaDevices.getUserMedia({
                            video: { facingMode: newMode },
                            audio: true
                        });
                        
                        TitanEngine.CoreState.LocalMediaStream = newStream;
                        document.getElementById('local-video-canvas').srcObject = newStream;
                        
                        const videoTrack = newStream.getVideoTracks()[0];
                        const sender = TitanEngine.CoreState.WebRTC_Peer.getSenders().find(s => s.track.kind === 'video');
                        if (sender) sender.replaceTrack(videoTrack);
                    }
                }
            },

            // Настройки Аккаунта
            AccountSettings: {
                updateNickname: async () => {
                    const newNick = prompt("Enter New Global ID:");
                    if (!newNick) return;

                    const uid = TitanEngine.CoreState.Identity.uid;
                    await update(ref(TITAN_DB, `v30/users/${uid}`), { id: newNick });
                    await set(ref(TITAN_DB, `v30/global_map/${newNick}`), uid);
                    alert("Identity Updated!");
                    location.reload();
                },

                toggleStealthMode: (checkbox) => {
                    if (checkbox.checked) {
                        document.body.style.filter = "contrast(1.2) brightness(0.8)";
                    } else {
                        document.body.style.filter = "none";
                    }
                }
            }
        };

        // СЛУШАТЕЛЬ ВХОДЯЩИХ СИГНАЛОВ (CALL LISTENER)
        function initializeCallSync() {
            const callRef = ref(TITAN_DB, `v30/calls/${TitanEngine.CoreState.Identity.uid}/signal`);
            onValue(callRef, async (snapshot) => {
                const callData = snapshot.val();
                
                if (callData && !TitanEngine.CoreState.WebRTC_Peer) {
                    if (confirm(`INCOMING SIGNAL FROM: ${callData.callerName}`)) {
                        TitanEngine.CoreState.ActiveChatPartner = { uid: callData.callerId, id: callData.callerName };
                        
                        await TitanEngine.MediaController.startVoiceCall(callData.video);
                        
                        await TitanEngine.CoreState.WebRTC_Peer.setRemoteDescription(new RTCSessionDescription(callData.offer));
                        const answer = await TitanEngine.CoreState.WebRTC_Peer.createAnswer();
                        await TitanEngine.CoreState.WebRTC_Peer.setLocalDescription(answer);
                        
                        await set(ref(TITAN_DB, `v30/calls/${callData.callerId}/answer`), answer);
                        
                        const iceRef = ref(TITAN_DB, `v30/calls/${TitanEngine.CoreState.Identity.uid}/ice_pool`);
                        onValue(iceRef, (iceSnap) => {
                            iceSnap.forEach((c) => {
                                TitanEngine.CoreState.WebRTC_Peer.addIceCandidate(new RTCIceCandidate(c.val()));
                            });
                        });
                    } else {
                        remove(ref(TITAN_DB, `v30/calls/${TitanEngine.CoreState.Identity.uid}`));
                    }
                }
            });
        }

        // ТОЧКА ВХОДА И КОНТРОЛЬ ЖИЗНЕННОГО ЦИКЛА
        onAuthStateChanged(TITAN_AUTH, (user) => {
            if (user) {
                onValue(ref(TITAN_DB, `v30/users/${user.uid}`), (snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        TitanEngine.CoreState.Identity = userData;
                        TitanEngine.NavigationController.navigateTo('hub');
                        
                        // Обновление UI настроек
                        document.getElementById('label-user-identity').innerText = "Node: " + userData.id;
                        document.getElementById('settings-display-nickname').innerText = userData.id;
                        document.getElementById('settings-display-email').innerText = userData.email;
                        document.getElementById('settings-avatar-placeholder').innerText = userData.id[0].toUpperCase();
                        
                        // Запуск фоновых процессов
                        TitanEngine.SocialManager.startContactListener();
                        initializeCallSync();
                    }
                });
            } else {
                TitanEngine.NavigationController.navigateTo('auth');
            }
        });

        console.log("TITAN MONOLITH v30.0 DEPLOYED SUCCESSFULLY");
    </script>
</body>
</html>
