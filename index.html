<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Morozov Ultra | Enterprise v4.6.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style id="ultra-styles">
        /* ПЕРЕМЕННЫЕ ДИНАМИЧЕСКИХ ТЕМ */
        :root {
            --u-bg: #0e1621; --u-surf: #17212b; --u-border: #242f3d;
            --u-text: #ffffff; --u-accent: #0088cc; --u-chat-bg: #070d14;
            --u-msg-me: #2b5278; --u-msg-he: #182533; --u-online: #4caf50;
        }

        .theme-arctic {
            --u-bg: #f0f2f5; --u-surf: #ffffff; --u-border: #e0e0e0;
            --u-text: #000000; --u-accent: #0088cc; --u-chat-bg: #e5e5e5;
            --u-msg-me: #0088cc; --u-msg-he: #ffffff; --u-online: #2e7d32;
        }

        .theme-matrix {
            --u-bg: #000000; --u-surf: #0a0a0a; --u-border: #00ff41;
            --u-text: #00ff41; --u-accent: #00ff41; --u-chat-bg: #000000;
            --u-msg-me: #003300; --u-msg-he: #001100; --u-online: #00ff41;
        }

        /* БАЗОВАЯ СТИЛИЗАЦИЯ */
        body, html { 
            height: 100%; width: 100%; margin: 0; padding: 0;
            background: var(--u-bg); color: var(--u-text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden; transition: background 0.3s, color 0.3s;
        }

        .u-screen {
            position: fixed; inset: 0; width: 100%; height: 100%;
            background: var(--u-bg); z-index: 10; display: flex; flex-direction: column;
            transition: transform 0.4s cubic-bezier(0.1, 0.7, 0.1, 1), opacity 0.3s;
        }
        .u-screen-hidden { transform: translateX(100%); opacity: 0; pointer-events: none; }
        .u-screen-active { transform: translateX(0); opacity: 1; z-index: 50; }

        /* ИНТЕРФЕЙС ЧАТА */
        .u-feed {
            flex: 1; overflow-y: auto; padding: 20px 15px;
            background: var(--u-chat-bg);
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: overlay; display: flex; flex-direction: column; gap: 12px;
        }

        .u-bubble {
            max-width: 82%; padding: 12px 16px; border-radius: 20px;
            font-size: 15px; position: relative; line-height: 1.4;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .u-bubble-me { align-self: flex-end; background: var(--u-msg-me); border-bottom-right-radius: 4px; color: white; }
        .u-bubble-he { align-self: flex-start; background: var(--u-msg-he); border-bottom-left-radius: 4px; color: var(--u-text); border: 1px solid var(--u-border); }

        /* СПЕЦИАЛЬНЫЕ ЭЛЕМЕНТЫ */
        .u-toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--u-accent); color: white; padding: 12px 24px;
            border-radius: 30px; z-index: 10000; font-weight: bold; font-size: 13px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: none;
        }

        .u-loader {
            width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.2);
            border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ВИДЕОЗВОНОК */
        #u-call-overlay {
            position: fixed; inset: 0; background: #000; z-index: 9000;
            display: none; flex-direction: column;
        }
        .u-v-remote { width: 100%; height: 100%; object-fit: cover; }
        .u-v-local {
            position: absolute; top: 40px; right: 20px;
            width: 110px; height: 160px; border-radius: 15px;
            border: 2px solid var(--u-accent); z-index: 9001;
        }
    </style>
</head>
<body class="theme-midnight">

    <div id="u-global-toast" class="u-toast">Уведомление</div>

    <div id="scr-auth" class="u-screen z-[9999] justify-center items-center p-6 bg-gradient-to-br from-gray-900 to-black">
        <div class="bg-white p-10 rounded-[45px] w-full max-w-md text-black shadow-2xl">
            <div class="text-center mb-8">
                <h1 class="text-5xl font-black text-blue-600 italic tracking-tighter">ULTRA</h1>
                <p class="text-[11px] font-bold text-gray-400 uppercase tracking-[0.3em] mt-2">Professional Infrastructure</p>
            </div>
            
            <div class="space-y-4">
                <input id="auth-email" type="email" placeholder="Email" class="w-full p-4 bg-gray-100 rounded-2xl outline-none focus:ring-2 ring-blue-500 transition-all">
                <input id="auth-pass" type="password" placeholder="Пароль (мин. 6 знаков)" class="w-full p-4 bg-gray-100 rounded-2xl outline-none focus:ring-2 ring-blue-500 transition-all">
                <div id="auth-reg-box" class="hidden animate-fade-in">
                    <input id="auth-nick" type="text" placeholder="Ваше имя" class="w-full p-4 bg-gray-100 rounded-2xl outline-none border-2 border-blue-100 mb-4">
                </div>
                
                <button id="auth-btn" onclick="handleAuthAction()" class="w-full bg-blue-600 text-white p-5 rounded-2xl font-black text-lg shadow-xl active:scale-95 transition-all flex justify-center items-center gap-3">
                    <span>ПРОДОЛЖИТЬ</span>
                </button>
                
                <button onclick="toggleAuthMode()" id="auth-mode-toggle" class="w-full text-xs font-bold text-gray-400 uppercase tracking-widest mt-4">Нет аккаунта? Создать</button>
            </div>
            <p id="auth-error-msg" class="mt-6 text-red-500 text-xs font-bold text-center"></p>
        </div>
    </div>

    <div id="scr-main" class="u-screen">
        <header class="h-20 bg-[var(--u-surf)] flex items-center justify-between px-6 border-b border-[var(--u-border)]">
            <button onclick="openSettingsScreen()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/5"><i class="fas fa-cog text-xl"></i></button>
            <div class="text-center">
                <span class="font-black text-xl italic text-blue-500">MOROZOV</span>
                <div class="text-[9px] opacity-40 font-bold uppercase tracking-widest">Ultra Network</div>
            </div>
            <button onclick="triggerFriendSearch()" class="w-10 h-10 flex items-center justify-center rounded-full bg-blue-600/20 text-blue-400"><i class="fas fa-search text-xl"></i></button>
        </header>

        <div id="main-notifications" class="bg-blue-600/10 hidden">
            <div class="px-6 py-3 flex justify-between items-center">
                <span class="text-[10px] font-black uppercase text-blue-400">Новые запросы</span>
                <span id="notif-count" class="bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded-full">0</span>
            </div>
            <div id="pending-requests-list"></div>
        </div>

        <div id="contact-list-container" class="flex-1 overflow-auto p-4 space-y-3">
            </div>
    </div>

    <div id="scr-chat" class="u-screen u-screen-hidden">
        <header class="h-16 bg-[var(--u-surf)] flex items-center px-4 border-b border-[var(--u-border)]">
            <button onclick="closeChatSession()" class="p-2"><i class="fas fa-chevron-left text-xl"></i></button>
            <div class="flex-1 ml-4 flex items-center gap-3">
                <div id="chat-avatar" class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center font-black">?</div>
                <div>
                    <div id="chat-partner-name" class="font-bold leading-none mb-1">...</div>
                    <div class="flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full bg-[var(--u-online)]"></span>
                        <span class="text-[9px] font-black opacity-50 uppercase">Secured</span>
                    </div>
                </div>
            </div>
            <div class="flex gap-6 pr-2">
                <button onclick="initiateCall('video')" class="text-gray-400 hover:text-white"><i class="fas fa-video"></i></button>
            </div>
        </header>

        <div id="chat-messages-feed" class="u-feed"></div>

        <div class="p-4 bg-[var(--u-surf)] flex items-end gap-3 border-t border-[var(--u-border)]">
            <label class="p-3 cursor-pointer text-gray-500 hover:text-blue-500 transition-colors">
                <i class="fas fa-plus-circle text-2xl"></i>
                <input type="file" class="hidden" onchange="handleFileUpload(this)" accept="image/*">
            </label>
            <div id="chat-input-field" contenteditable="true" class="flex-1 bg-[var(--u-bg)] p-3 rounded-2xl outline-none max-h-32 overflow-y-auto text-sm border border-[var(--u-border)]" oninput="toggleSendIcon()"></div>
            <button id="chat-send-btn" onclick="dispatchMessage()" class="hidden w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center shadow-lg transform active:scale-90 transition">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <div id="scr-settings" class="u-screen u-screen-hidden">
        <header class="h-16 bg-[var(--u-surf)] flex items-center px-6 border-b border-[var(--u-border)]">
            <button onclick="closeSettingsScreen()"><i class="fas fa-arrow-left text-xl mr-6"></i></button>
            <span class="font-black text-xl uppercase tracking-tighter">Настройки Профиля</span>
        </header>

        <div class="flex-1 overflow-auto bg-[var(--u-bg)]">
            <div class="p-10 flex flex-col items-center bg-[var(--u-surf)] border-b border-[var(--u-border)]">
                <div id="st-big-avatar" class="w-24 h-24 bg-blue-600 rounded-[35%] flex items-center justify-center text-4xl font-black mb-4 shadow-2xl">?</div>
                <h2 id="st-display-name" class="text-2xl font-black tracking-tight">User</h2>
                <p id="st-display-email" class="text-xs opacity-40 font-mono mt-1">...</p>
                <button onclick="editUserName()" class="mt-4 px-6 py-2 bg-white/5 rounded-full text-[10px] font-black uppercase hover:bg-white/10 transition">Изменить имя</button>
            </div>

            <p class="px-8 py-6 text-[11px] font-black text-blue-500 uppercase tracking-[0.2em]">Внешний вид</p>
            <div class="grid grid-cols-3 gap-4 px-8 mb-8">
                <button onclick="applyAppTheme('midnight')" class="flex flex-col items-center gap-2">
                    <div class="w-full aspect-square rounded-2xl bg-[#0e1621] border-2 border-white/10"></div>
                    <span class="text-[9px] font-bold uppercase">Midnight</span>
                </button>
                <button onclick="applyAppTheme('arctic')" class="flex flex-col items-center gap-2">
                    <div class="w-full aspect-square rounded-2xl bg-white border-2 border-black/10"></div>
                    <span class="text-[9px] font-bold uppercase">Arctic</span>
                </button>
                <button onclick="applyAppTheme('matrix')" class="flex flex-col items-center gap-2">
                    <div class="w-full aspect-square rounded-2xl bg-black border-2 border-[#00ff41]"></div>
                    <span class="text-[9px] font-bold uppercase">Matrix</span>
                </button>
            </div>

            <p class="px-8 py-2 text-[11px] font-black text-red-500 uppercase tracking-[0.2em]">Система</p>
            <div class="px-4 space-y-1">
                <div class="flex items-center justify-between p-4 bg-[var(--u-surf)] rounded-2xl" onclick="copyUserUID()">
                    <div><div class="font-bold text-sm">Ваш идентификатор (UID)</div><div id="st-uid-val" class="text-[10px] opacity-30 font-mono">...</div></div>
                    <i class="fas fa-copy opacity-30"></i>
                </div>
                <div class="flex items-center justify-between p-4 bg-[var(--u-surf)] rounded-2xl text-red-500" onclick="handleSignOut()">
                    <div class="font-bold text-sm">Выйти из аккаунта</div>
                    <i class="fas fa-sign-out-alt"></i>
                </div>
            </div>
        </div>
    </div>

    <div id="u-call-overlay">
        <video id="remote-video" class="u-v-remote" autoplay playsinline></video>
        <video id="local-video" class="u-v-local" autoplay muted playsinline></video>
        <div class="absolute inset-0 flex flex-col justify-between items-center py-20 bg-gradient-to-b from-black/60 via-transparent to-black/80">
            <div class="text-center">
                <div id="call-ui-avatar" class="w-24 h-24 bg-blue-600 rounded-full mx-auto flex items-center justify-center text-4xl font-black mb-6 border-4 border-white/20">?</div>
                <h2 id="call-ui-name" class="text-3xl font-black text-white">ВЫЗОВ</h2>
                <div class="flex items-center justify-center gap-2 mt-2">
                    <span class="w-2 h-2 bg-red-500 rounded-full animate-ping"></span>
                    <span class="text-xs font-bold text-blue-400 uppercase tracking-widest">End-to-End Encrypted</span>
                </div>
            </div>
            <button onclick="terminateCurrentCall()" class="w-20 h-20 bg-red-600 text-white rounded-full flex items-center justify-center text-3xl shadow-[0_0_50px_rgba(220,38,38,0.5)] active:scale-75 transition-all">
                <i class="fas fa-phone-slash"></i>
            </button>
        </div>
    </div>

    <script type="module">
        // ИМПОРТ МОДУЛЕЙ FIREBASE 10.7+
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, update, get, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // КОНФИГУРАЦИЯ СЕРВЕРОВ (MOROZOV INFRASTRUCTURE)
        const firebaseConfig = {
            apiKey: "AIzaSyDutfZZER58asyHr68zWlCx7B5k1adFhIk",
            authDomain: "morozov-ultra.firebaseapp.com",
            databaseURL: "https://morozov-ultra-default-rtdb.firebaseio.com",
            projectId: "morozov-ultra",
            storageBucket: "morozov-ultra.firebasestorage.app",
            appId: "1:255345933856:web:5b8d1b93696f36eb5d4645"
        };

        // ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ СОСТОЯНИЯ
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let currentUser = null;
        let activeChatPartner = null;
        let rtcPeerConnection = null;
        let isRegistrationMode = false;

        // --- БЛОК 1: СИСТЕМА УВЕДОМЛЕНИЙ (TOASTS) ---
        function showToast(text, duration = 3000) {
            const t = document.getElementById('u-global-toast');
            t.innerText = text;
            t.style.display = 'block';
            setTimeout(() => { t.style.display = 'none'; }, duration);
        }

        // --- БЛОК 2: АВТОРИЗАЦИЯ И УПРАВЛЕНИЕ СЕССИЕЙ ---
        window.toggleAuthMode = () => {
            isRegistrationMode = !isRegistrationMode;
            document.getElementById('auth-reg-box').classList.toggle('hidden', !isRegistrationMode);
            document.getElementById('auth-mode-toggle').innerText = isRegistrationMode ? "Уже есть аккаунт? Войти" : "Нет аккаунта? Создать";
        };

        window.handleAuthAction = async () => {
            const email = document.getElementById('auth-email').value.trim();
            const pass = document.getElementById('auth-pass').value.trim();
            const nick = document.getElementById('auth-nick').value.trim();
            const errBox = document.getElementById('auth-error-msg');
            const btn = document.getElementById('auth-btn');

            if (!email || pass.length < 6) {
                errBox.innerText = "Проверьте почту и пароль (мин. 6 симв.)";
                return;
            }

            btn.disabled = true;
            btn.innerHTML = `<div class="u-loader"></div>`;

            try {
                if (isRegistrationMode) {
                    const res = await createUserWithEmailAndPassword(auth, email, pass);
                    await updateProfile(res.user, { displayName: nick || "User" });
                    await set(ref(db, `v18/users/${res.user.uid}`), { 
                        email, name: nick || "User", uid: res.user.uid, about: "Using Morozov Ultra" 
                    });
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch (err) {
                errBox.innerText = "Ошибка: " + err.message;
            } finally {
                btn.disabled = false;
                btn.innerHTML = "<span>ПРОДОЛЖИТЬ</span>";
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('scr-auth').style.display = 'none';
                initApplicationLogic();
            } else {
                document.getElementById('scr-auth').style.display = 'flex';
            }
        });

        // --- БЛОК 3: СОЦИАЛЬНАЯ ЛОГИКА (ДРУЗЬЯ) ---
        function initApplicationLogic() {
            console.log("Ultra Core: Запуск систем...");
            
            // 1. Слушаем изменения списка друзей
            onValue(ref(db, `v18/social/${currentUser.uid}`), (snap) => {
                const list = document.getElementById('contact-list-container');
                const pendingList = document.getElementById('pending-requests-list');
                const notifArea = document.getElementById('main-notifications');
                const countBadge = document.getElementById('notif-count');

                list.innerHTML = ""; pendingList.innerHTML = "";
                let pCount = 0;

                snap.forEach(s => {
                    const friend = s.val();
                    if (friend.status === 'request') {
                        pCount++;
                        const el = document.createElement('div');
                        el.className = "flex items-center justify-between p-4 border-b border-white/5";
                        el.innerHTML = `<div class="text-sm font-bold">${friend.name}</div>
                                        <button onclick="acceptFriendship('${friend.id}')" class="bg-blue-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase">Принять</button>`;
                        pendingList.appendChild(el);
                    } else if (friend.status === 'active') {
                        const el = document.createElement('div');
                        el.className = "flex items-center p-4 bg-[var(--u-surf)] rounded-2xl border border-[var(--u-border)] active:scale-[0.98] transition cursor-pointer";
                        el.innerHTML = `<div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center font-black mr-4 text-xl">${friend.name[0]}</div>
                                        <div class="flex-1">
                                            <div class="font-black text-lg leading-none">${friend.name}</div>
                                            <div class="text-[10px] opacity-40 uppercase font-bold mt-1 tracking-wider">На связи</div>
                                        </div>
                                        <i class="fas fa-chevron-right opacity-10"></i>`;
                        el.onclick = () => startChatSession(friend);
                        list.appendChild(el);
                    }
                });

                notifArea.classList.toggle('hidden', pCount === 0);
                countBadge.innerText = pCount;
            });

            // 2. Слушаем входящие вызовы
            listenForInboundCalls();
        }

        window.triggerFriendSearch = async () => {
            const email = prompt("Введите Email пользователя:");
            if (!email || email === currentUser.email) return;

            showToast("Поиск...");
            const snap = await get(ref(db, `v18/users`));
            let target = null;
            snap.forEach(s => { if (s.val().email === email) target = s.val(); });

            if (target) {
                await update(ref(db, `v18/social/${target.uid}/${currentUser.uid}`), { id: currentUser.uid, name: currentUser.displayName, status: 'request' });
                await update(ref(db, `v18/social/${currentUser.uid}/${target.uid}`), { id: target.uid, name: target.name, status: 'waiting' });
                showToast("Запрос отправлен!");
            } else {
                showToast("Пользователь не найден");
            }
        };

        window.acceptFriendship = async (fid) => {
            await update(ref(db, `v18/social/${currentUser.uid}/${fid}`), { status: 'active' });
            await update(ref(db, `v18/social/${fid}/${currentUser.uid}`), { status: 'active' });
            showToast("Контакт добавлен");
        };

        // --- БЛОК 4: ИНЖЕНЕРИЯ ЧАТА ---
        window.startChatSession = (partner) => {
            activeChatPartner = partner;
            document.getElementById('scr-chat').classList.add('u-screen-active');
            document.getElementById('chat-partner-name').innerText = partner.name;
            document.getElementById('chat-avatar').innerText = partner.name[0];
            
            const roomID = [currentUser.uid, partner.id].sort().join("___");
            onValue(ref(db, `v18/messages/${roomID}`), (snap) => {
                const feed = document.getElementById('chat-messages-feed');
                feed.innerHTML = "";
                snap.forEach(m => {
                    const msg = m.val();
                    const isMe = msg.sid === currentUser.uid;
                    const bubble = document.createElement('div');
                    bubble.className = `u-bubble ${isMe ? 'u-bubble-me' : 'u-bubble-he'}`;
                    
                    if (msg.tp === 'img') bubble.innerHTML = `<img src="${msg.body}" class="rounded-lg shadow-sm">`;
                    else bubble.innerHTML = `<div>${msg.body}</div>`;

                    feed.appendChild(bubble);
                });
                feed.scrollTop = feed.scrollHeight;
            });
        };

        window.dispatchMessage = () => {
            const field = document.getElementById('chat-input-field');
            const text = field.innerText.trim();
            if (!text) return;

            const roomID = [currentUser.uid, activeChatPartner.id].sort().join("___");
            push(ref(db, `v18/messages/${roomID}`), {
                sid: currentUser.uid, body: text, tp: 'text', ts: Date.now()
            });
            field.innerText = ""; toggleSendIcon();
        };

        window.handleFileUpload = (input) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const roomID = [currentUser.uid, activeChatPartner.id].sort().join("___");
                push(ref(db, `v18/messages/${roomID}`), {
                    sid: currentUser.uid, body: e.target.result, tp: 'img', ts: Date.now()
                });
            };
            reader.readAsDataURL(file);
        };

        // --- БЛОК 5: WebRTC ЗВОНКИ (P2P СЛОЙ) ---
        const iceConfig = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

        window.initiateCall = async (type) => {
            console.log("RTC: Исходящий вызов...");
            rtcPeerConnection = new RTCPeerConnection(iceConfig);
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            stream.getTracks().forEach(t => rtcPeerConnection.addTrack(t, stream));
            
            document.getElementById('local-video').srcObject = stream;
            document.getElementById('u-call-overlay').style.display = 'flex';
            document.getElementById('call-ui-name').innerText = activeChatPartner.name;
            document.getElementById('call-ui-avatar').innerText = activeChatPartner.name[0];

            rtcPeerConnection.onicecandidate = (e) => {
                if (e.candidate) push(ref(db, `v18/calls/${activeChatPartner.id}/ice`), e.candidate.toJSON());
            };
            rtcPeerConnection.ontrack = (e) => document.getElementById('remote-video').srcObject = e.streams[0];

            const offer = await rtcPeerConnection.createOffer();
            await rtcPeerConnection.setLocalDescription(offer);

            set(ref(db, `v18/calls/${activeChatPartner.id}/signal`), {
                offer, from: currentUser.uid, name: currentUser.displayName
            });

            onValue(ref(db, `v18/calls/${activeChatPartner.id}/answer`), async snap => {
                if (snap.val() && !rtcPeerConnection.currentRemoteDescription) {
                    await rtcPeerConnection.setRemoteDescription(new RTCSessionDescription(snap.val()));
                }
            });
        };

        function listenForInboundCalls() {
            onValue(ref(db, `v18/calls/${currentUser.uid}/signal`), async snap => {
                const data = snap.val();
                if (data && data.offer && !rtcPeerConnection) {
                    if (confirm(`Входящий видеозвонок от ${data.name}. Ответить?`)) {
                        rtcPeerConnection = new RTCPeerConnection(iceConfig);
                        const s = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                        s.getTracks().forEach(t => rtcPeerConnection.addTrack(t, s));
                        
                        document.getElementById('local-video').srcObject = s;
                        document.getElementById('u-call-overlay').style.display = 'flex';
                        rtcPeerConnection.ontrack = (e) => document.getElementById('remote-video').srcObject = e.streams[0];
                        rtcPeerConnection.onicecandidate = (e) => {
                            if (e.candidate) push(ref(db, `v18/calls/${data.from}/ice`), e.candidate.toJSON());
                        };

                        await rtcPeerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                        const answer = await rtcPeerConnection.createAnswer();
                        await rtcPeerConnection.setLocalDescription(answer);
                        set(ref(db, `v18/calls/${data.from}/answer`), answer);

                        onValue(ref(db, `v18/calls/${currentUser.uid}/ice`), sn => {
                            sn.forEach(c => rtcPeerConnection.addIceCandidate(new RTCIceCandidate(c.val())));
                        });
                    } else {
                        remove(ref(db, `v18/calls/${currentUser.uid}`));
                    }
                }
            });
        }

        // --- БЛОК 6: НАСТРОЙКИ И ТЕМЫ ---
        window.applyAppTheme = (t) => {
            document.body.className = 'theme-' + t;
            localStorage.setItem('u-selected-theme', t);
        };
        applyAppTheme(localStorage.getItem('u-selected-theme') || 'midnight');

        window.openSettingsScreen = () => {
            document.getElementById('st-display-name').innerText = currentUser.displayName;
            document.getElementById('st-display-email').innerText = currentUser.email;
            document.getElementById('st-uid-val').innerText = currentUser.uid;
            document.getElementById('st-big-avatar').innerText = currentUser.displayName[0];
            document.getElementById('scr-settings').classList.add('u-screen-active');
        };

        window.editUserName = async () => {
            const n = prompt("Новое имя:", currentUser.displayName);
            if (n && n.length > 2) {
                await updateProfile(currentUser, { displayName: n });
                await update(ref(db, `v18/users/${currentUser.uid}`), { name: n });
                openSettingsScreen();
                showToast("Имя обновлено");
            }
        };

        // ВСПОМОГАТЕЛЬНОЕ
        window.terminateCurrentCall = () => location.reload();
        window.closeChatSession = () => document.getElementById('scr-chat').classList.remove('u-screen-active');
        window.closeSettingsScreen = () => document.getElementById('scr-settings').classList.remove('u-screen-active');
        window.handleSignOut = () => signOut(auth).then(() => location.reload());
        window.copyUserUID = () => { navigator.clipboard.writeText(currentUser.uid); showToast("UID скопирован"); };
        window.toggleSendIcon = () => {
            const has = document.getElementById('chat-input-field').innerText.trim().length > 0;
            document.getElementById('chat-send-btn').classList.toggle('hidden', !has);
        };
    </script>
</body>
</html>
